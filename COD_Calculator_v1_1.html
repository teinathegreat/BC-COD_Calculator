
<!DOCTYPE html>
<!-- Bachcare Calculator — Base Working Version (v1.0) -->
<!-- v1.0: Add "Charge Amendment Fee" checkbox (single fee) and include Owner GST in New Booking Total -->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bachcare Calculator (Standalone) — (v1.0)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flatpickr (calendar picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <style>
    .card{background:#fff;border:1px solid #f1f5f9;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;justify-content:space-between;align-items:center}
    .tile{background:#f8fafc;border:1px solid #f1f5f9;border-radius:1rem;padding:1rem}
    .mini{font-size:.8rem;color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.5rem;background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem;font-weight:600}
    .tab{padding:.5rem 1rem;border:1px solid #e2e8f0;border-bottom:none;border-top-left-radius:.75rem;border-top-right-radius:.75rem;background:#f8fafc;margin-right:.5rem;cursor:pointer}
    .tab.active{background:#fff;font-weight:600}
    .tabpanes{border:1px solid #e2e8f0;border-radius:0 1rem 1rem 1rem;overflow:hidden}
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .modal{max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .hidden-soft{display:none}
    .disabled-soft{opacity:.5;pointer-events:none}
    #previewCOD{max-height:20rem;overflow:auto}
    @media (min-width:1024px){ #htmlCOD{height:20rem} }
  
    /* Platform lock */
    .calc-body.locked { opacity: 0.35; filter: grayscale(0.2); pointer-events: none; }
    .lock-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 50; }
    .lock-card { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.08); border-radius: 18px; padding: 28px 26px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); text-align: center; max-width: 520px; }
    .lock-title { font-size: 36px; font-weight: 800; letter-spacing: -0.02em; }
    .lock-sub { margin-top: 10px; font-size: 14px; color: rgba(0,0,0,0.65); }
    #calcPane { position: relative; }

</style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen w-full max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold tracking-tight mb-4">Booking Adjustment Calculator (NZD)</h1>

<span class="ml-3 inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-700">
  Version 1.0
</span>


    <!-- Tabs -->
    <div class="flex mb-2 gap-2">
      <button class="tab active" data-tab="calcPane">Calculator</button>
      <button class="tab" data-tab="settingsPane">Settings</button>
      <button class="tab" data-tab="sessionsPane">Sessions</button>
    </div>

    <div class="tabpanes bg-white rounded-xl">
      <!-- Calculator Pane -->
      <div id="calcPane" class="p-4">
      <div id="platformLockOverlay" class="lock-overlay hidden">
        <div class="lock-card">
          <div class="lock-title">Select Platform</div>
          <div class="lock-sub">Choose Airbnb, Booking.com, VRBO, or Direct to unlock the calculator.
        <div class="mt-6">
          <select id="channelOverlay"
            class="mx-auto block w-full max-w-xs rounded-xl border border-gray-300 bg-white px-4 py-2 text-center">
            <option value="" selected disabled>Select Platform</option>
            <option value="direct|Bachcare Direct|0">Bachcare Direct</option>
            <option value="bcom|Booking.com|0.239">Booking.com</option>
            <option value="vrbo|VRBO|0.202">VRBO</option>
            <option value="airbnb|Airbnb|0.255">Airbnb</option>
          </select>
        </div>
    </div>
        </div>
      </div>
      <div id="calcBody" class="calc-body">

        <!-- Platform + Reset -->
        <div class="mb-4 flex flex-wrap items-end gap-3">
          <label class="text-sm text-gray-700">
            Platform
            <select id="channel" class="ml-2 px-3 py-2 rounded-xl border border-gray-300 bg-white align-middle">
                <option value="" selected disabled>Select Platform</option>
              <option value="direct|Bachcare Direct|0">Bachcare Direct</option>
              <option value="bcom|Booking.com|0.239">Booking.com</option>
              <option value="vrbo|VRBO|0.202">VRBO</option>
              <option value="airbnb|Airbnb|0.255">Airbnb</option>
            </select>
          </label>
          <button id="resetBtn" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">Reset</button>
        </div>

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Dates</h2>
            <label class="block"><span class="text-sm font-medium text-gray-700">Start</span>
              <input type="text" id="origStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>
            <label class="block"><span class="text-sm font-medium text-gray-700">End</span>
              <input type="text" id="origEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="origNights">0</span></div>
          </section>

          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Dates</h2>
            <label class="block"><span class="text-sm font-medium text-gray-700">Start</span>
              <input type="text" id="newStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>
            <label class="block"><span class="text-sm font-medium text-gray-700">End</span>
              <input type="text" id="newEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="newNights">0</span></div>
          </section>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <!-- Original Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Booking</h2>

            <label class="block"><span class="text-sm font-medium text-gray-700">Property ID</span>
              <input type="text" id="propIdOld" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 341234">
            </label>

            <!-- OTA-only simplified input -->
            <div id="obOtaFields" class="grid grid-cols-1 gap-3 mt-3 hidden-soft">
              <label class="block"><span class="text-sm font-medium text-gray-700">Total Holiday Cost</span>
                <input type="text" id="otaTotal1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <div class="mini">Used when Platform is Airbnb, Booking.com or VRBO.</div>
            </div>

            <!-- Direct-only full breakdown (GEL removed from original) -->
            <div id="obDirectFields" class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Rent (total)</span>
                <input type="text" id="rent1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (enter known)</span>
                <input type="text" id="fee1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 40.00">
              </label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                  <input type="text" id="addInfo1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
                </label>
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                  <input type="text" id="addAmt1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
                </label>
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>

            <!-- Direct breakdown rows (no GEL row) -->
            <div id="obBreakdown" class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent</span><span id="obRent">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Linen</span><span id="obLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="obClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee</span><span id="obFee">$0.00</span></div>
              <div class="row"><span id="obAddLabel" class="text-gray-600">Additional Charges</span><span id="obAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="obMarkup">$0.00</span></div>
            </div>

            <!-- OTA summary row -->
            <div id="obOtaSummary" class="space-y-1 text-sm hidden-soft">
              <div class="row"><span class="text-gray-600">Total Holiday Cost</span><span id="obOtaTotal">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">Original Booking Total</span><span id="total1" class="font-semibold">$0.00</span></div>
          </section>

          <!-- New Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Booking</h2>
<input type="hidden" id="propIdNew" value="">
            <!-- Daily Modifier Rates -->
            <div id="perNightBlock" class="mt-2">
              <h3 class="font-semibold">Daily Modifier Rates (New Booking)</h3>
              <div id="nightlyHint" class="mini">Set <b>New Start</b> and <b>New End</b> dates to generate one input per night.</div>
              <div id="nightlyWrap" class="mt-2">
                <div id="nightlyGrid" class="grid gap-2"></div>
                <div class="row mt-2"><span class="text-gray-600">Rent (sum of nights)</span><span id="rent2Sum">$0.00</span></div>
              </div>
            </div>

            <!-- Stack: Linen, Cleaning, Booking Fee -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (auto, capped $299)</span>
                <input type="text" id="fee2" class="mt-1 w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2" placeholder="auto" readonly>
              </label>
            </div>

            <!-- Additional charge side-by-side -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                <input type="text" id="addInfo2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                <input type="text" id="addAmt2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
              </label>
            </div>

            <!-- Amendment fee (direct-only) -->
            <div class="mt-3">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="chargeAmendFee2" class="h-4 w-4 rounded border-gray-300">
                <span class="text-sm font-medium text-gray-700">Charge Amendment Fee</span>
              </label>
              <div class="mini mt-1">Adds one amendment fee (set in <b>Settings</b>). Bachcare Direct only.</div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>
            <div class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent (sum nights)</span><span id="nbRent">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Linen</span><span id="nbLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="nbClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee</span><span id="nbFee">$0.00</span></div>
              <div class="row"><span id="nbAddLabel" class="text-gray-600">Additional Charges</span><span id="nbAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="nbMarkup">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Owner GST Total</span><span id="ownerGST2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Amendment Fee</span><span id="nbAmend">$0.00</span></div>
            </div>

            <!-- Toggle: include Owner GST -->
            

            <div class="row mt-2"><span class="text-gray-600">New Booking Total</span><span id="total2" class="font-semibold">$0.00</span></div>
          </section>

          <div class="lg:col-span-2">
            <div class="mt-6 card">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Outcome</h3>
                <div>Scenario: <span id="scenarioBadge" class="badge">—</span></div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-2">
                <div class="tile"><div class="text-sm text-gray-600">Original Total</div><div id="tile1" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">Original booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600">New Total</div><div id="tile2" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">New booking charges.</div></div>
                <div class="tile">
                  <div class="text-sm text-gray-600" id="tile3label">Amount to charge/refund guest</div>
                  <div id="tile3" class="text-2xl font-semibold">—</div>
                  <div class="text-xs text-gray-500" id="tile3desc">Based on totals above</div>
                </div>
              </div>

              <!-- Breakdown + Preview side by side -->
              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-5">
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Finance Breakdown Itinerary Note</h2>
                  <textarea id="htmlCOD" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
                  <button id="copyCOD" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
                </section>
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Preview</h2>
                  <div id="previewCOD" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
                </section>
              </div>

              <!-- Direct-only pre-drafted guest email -->
              <div class="mt-4 grid grid-cols-1">
                <section id="guestEmailCard" class="card hidden-soft">
                  <h2 class="text-xl font-semibold mb-3">Guest Email (Direct bookings)</h2>
                  <textarea id="guestEmail" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm h-64" readonly></textarea>
                  <button id="copyGuestEmail" class="mt-2 px-3 py-2 rounded-xl bg-blue-600 text-white">Copy Email</button>
                  <div class="mini mt-2">This section shows only for <b>Bachcare Direct</b> and updates automatically.</div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-5">Tip: Enter numbers only (e.g. 120 or 120.50). Currency shown in NZD. Dates accept dd/mm/yyyy or yyyy-mm-dd.</p>
      </div>

      <!-- Settings Pane -->
      </div>

      <div id="settingsPane" class="p-4 hidden">
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Owner GST Rate</span></div>
          <input type="text" id="ownerGSTRate" value="0.15" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Used for Owner GST Total (display or included), and for channel markup basis.</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Booking Fee Rate</span></div>
          <input type="text" id="bookingFeeRate" value="0.071" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">New Booking Booking Fee = (Rent + GEL) × rate. Capped at $299.</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Amendment Fee (each)</span></div>
          <input type="text" id="amendFeeEach" value="28.75" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Total Amendment Fee = count × per-fee.</div>
        </section>
        <section class="card">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Channel Markups</span></div>

          <div class="mt-2">
            <label class="text-sm font-medium block">Airbnb Markup %</label>
            <input type="text" id="mkAirbnb" value="25.5" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
            <div class="mini mt-1">Markup = ((Rent × 1.15) + GEL + Booking Fee) × Airbnb %</div>
          </div>

          <div class="mt-4">
            <label class="text-sm font-medium block">Booking.com Markup %</label>
            <input type="text" id="mkBcom" value="23.9" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
            <div class="mini mt-1">Markup = ((Rent × 1.15) + GEL + Booking Fee) × Booking.com %</div>
          </div>

          <div class="mt-4">
            <label class="text-sm font-medium block">VRBO Markup %</label>
            <input type="text" id="mkVrbo" value="20.2" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
            <div class="mini mt-1">Markup = ((Rent × 1.15) + GEL + Booking Fee) × VRBO %</div>
          </div>

          <div class="mini mt-3">Changing these updates the Platform dropdown on the Calculator tab.</div>
        </section>
</div>

      <!-- Sessions Pane -->
      <div id="sessionsPane" class="p-4 hidden">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Save / Load / Delete Sessions</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-end">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Saved Sessions</label>
              <select id="sessionPicker" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white">
                <option value="">— none —</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Name</label>
              <input id="sessionName" type="text" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white" placeholder="e.g. Smith 23–28 Aug"/>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="sessionSave" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save as New / Overwrite</button>
              <button id="sessionLoad" class="px-3 py-2 rounded-xl bg-blue-600 text-white">Load</button>
              <button id="sessionDelete" class="px-3 py-2 rounded-xl bg-red-600 text-white">Delete</button>
            </div>
          </div>
          <div class="mini mt-2">Sessions are stored locally in your browser. Nightly “Daily Modifier Rates” are included.</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal: Bachcare Direct non-overlap -->
  <div id="directModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="dm-title" aria-describedby="dm-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-red-50 border border-red-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="dm-title" class="text-xl font-semibold text-gray-900">Calculator not needed</h3>
            <p id="dm-desc" class="mt-2 text-gray-700">
              This is a <b>Bachcare Direct</b> booking and the <b>new dates do not overlap</b> the original dates.
              Please create a <b>new offline booking</b> — that will give the correct total automatically.
            </p>
            <p class="mt-2 text-sm text-gray-500">You can still use the calculator if you need a manual comparison, but it’s not required for this scenario.</p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="dmClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Direct 30-day policy (Change/RON) -->
  <div id="direct30Modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="d30-title" aria-describedby="d30-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-amber-50 border border-amber-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="d30-title" class="text-xl font-semibold text-gray-900">Approval required</h3>
            <p id="d30-desc" class="mt-2 text-gray-700">
              For <b>Bachcare Direct</b>, <b>date changes</b> and <b>reductions of nights</b> can only be processed <b>outside of 30 days</b> of the booking start per policy.
              This request appears to be <b>inside 30 days</b>. Please seek <b>Team Leader approval</b> before proceeding.<br><br>
              <i>If you are only <b>adding an extension</b> to the existing booking, you may disregard this message and click OK to continue.</i>
            </p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="d30Close" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: OTA Extension during active stay (Airbnb/Booking.com) -->
  <div id="otaExtActiveModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="oea-title" aria-describedby="oea-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-blue-50 border border-blue-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M5 12h14" />
            </svg>
          </div>
          <div>
            <h3 id="oea-title" class="text-xl font-semibold text-gray-900">Extension during active stay</h3>
            <p id="oea-desc" class="mt-2 text-gray-700">
              For <b>Airbnb</b> and <b>Booking.com</b> extensions requested while the stay is <b>in progress</b>, please <b>take payment by phone</b>. Their portals typically do not allow last-minute changes.<br><br>
              Also create a <b>workflow advising Finance</b> to note that partial payment was taken by phone while the balance will flow through the portal.
            </p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="oeaClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: OTA Portal Date Change guidance (Airbnb/Booking.com) -->
  <div id="otaChangePortalModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="ocp-title" aria-describedby="ocp-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-cyan-50 border border-cyan-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h8M8 14h6M4 6h16M4 18h16" />
            </svg>
          </div>
          <div>
            <h3 id="ocp-title" class="text-xl font-semibold text-gray-900">Change of dates via portal</h3>
            <p id="ocp-desc" class="mt-2 text-gray-700">
              For <b>Airbnb</b> and <b>Booking.com</b> <b>change of dates</b>, please ask the guest to <b>request the change in the portal</b>. We will accept it on our side.<br><br>
              This ensures their system calculates the correct amount. We <b>don’t need this calculator</b> for this process. Once approved, update Enterprise to match the portal and <b>copy their breakdown</b> into itinerary notes. <b>Workflow Finance</b> to adjust the Enterprise breakdown.
            </p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="ocpClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: OTA Free-cancellation approval (Airbnb/Booking.com) -->
  <div id="otaApprovalModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="oap-title" aria-describedby="oap-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-amber-50 border border-amber-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="oap-title" class="text-xl font-semibold text-gray-900">Outside free-cancellation window</h3>
            <p id="oap-desc" class="mt-2 text-gray-700">
              This <b><span id="oap-chan">OTA</span></b> request (<b><span id="oap-type">Change/RON</span></b>) appears to be <b>inside</b> the free-cancellation window.<br><br>
              • <b>Booking.com:</b> 7 days before start<br>
              • <b>Airbnb:</b> 30 days before start<br><br>
              Please <b>seek Team Leader approval</b> before proceeding. Ensure all changes are noted in itinerary notes and that portal breakdowns are copied for Finance.
            </p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="oapClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Reduction of nights not supported for third-party channels -->
  <div id="otaRonLimitModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="ronl-title" aria-describedby="ronl-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-amber-50 border border-amber-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="ronl-title" class="text-xl font-semibold text-gray-900">System limitation</h3>
            <p id="ronl-desc" class="mt-2 text-gray-700">
              Unfortunately there is a system limitation for reduction of nights on third party channels.
              Please advise the guest that if they are within their cancellation policy for a full refund, they can cancel their booking to receive a refund and then rebook with the new dates.
            </p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="ronlClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ---------- Helpers ----------
    const el = (id) => document.getElementById(id);

    // ---------- Platform Lock ----------
    function isPlatformSelected() {
      const v = (el("channel")?.value || "").trim();
      return v !== "";
    }

    function updatePlatformLock() {
      const locked = !isPlatformSelected();
      const body = document.getElementById("calcBody");
      const ov = document.getElementById("platformLockOverlay");
      if (body) body.classList.toggle("locked", locked);
      if (ov) ov.classList.toggle("hidden", !locked);
      return !locked;
    }


    // Sync overlay platform selector
    const overlaySel = document.getElementById("channelOverlay");
    if (overlaySel) {
      overlaySel.addEventListener("change", () => {
        el("channel").value = overlaySel.value;
        updatePlatformLock();
        recompute();
      });
    }

const toCents = (v) => { const n = typeof v === "number" ? v : parseFloat(String(v || "").replace(/[^0-9.-]/g, "")); if (Number.isNaN(n)) return 0; return Math.round(n * 100); };
    const nzd = (c) => new Intl.NumberFormat("en-NZ", { style: "currency", currency: "NZD" }).format((c || 0) / 100);
    const DAY = 86400000;
    function todayUTC(){ const n=new Date(); return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate())); }

    // Dates
    function getDateVal(id) {
      const v = (el(id)?.value || "").trim();
      if (!v) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) { const [y, m, d] = v.split("-").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) { const [d, m, y] = v.split("/").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      const tryD = new Date(v); return isNaN(tryD) ? null : new Date(Date.UTC(tryD.getUTCFullYear(), tryD.getUTCMonth(), tryD.getUTCDate()));
    }
    const dtIso = (d) => d.toISOString().slice(0, 10);
    function dtNZ(d){ if(!(d instanceof Date) || isNaN(d)) return ""; const dd=String(d.getUTCDate()).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const yy=d.getUTCFullYear(); return `${dd}/${mm}/${yy}`; }
    const nightsBetween = (a, b) => Math.max(0, Math.round((b - a) / DAY));
    const overlaps = (a1, a2, b1, b2) => a1 && a2 && b1 && b2 && (a1 <= b2) && (b1 <= a2);

    // ---------- Constants ----------
    const GEL_PER_NIGHT_C = 1200;
    const BOOKING_FEE_CAP_C = 29900;

    let lastNewStart = "", lastNewEnd = "";
    let lastNightlyKey = "";
    let lastDirectModalKey = "";
    let lastDirect30Key = "";

    // OTA modal dedupe keys
    let lastOtaExtKey = "";
    let lastOtaChangeKey = "";
    let lastOtaApprovalKey = "";

    // ---------- Sessions (unchanged from v1.0) ----------
    const SESS_KEY = "bachcareCalc:sessions";
    function readSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||"{}"); }catch(_){ return {}; } }
    function writeSessions(obj){ localStorage.setItem(SESS_KEY, JSON.stringify(obj||{})); refreshSessionPicker(); }
    function refreshSessionPicker(){
      const sel = el("sessionPicker"); if(!sel) return;
      const cur = sel.value;
      sel.innerHTML = `<option value="">— none —</option>`;
      const sessions = readSessions();
      Object.keys(sessions).sort().forEach(name=>{
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
      if(cur && sessions[cur]) sel.value = cur;
    }
    function collectNightlyRates(){
      const arr = [];
      document.querySelectorAll("#nightlyGrid .grid").forEach(row=>{
        const dateTxt = row.querySelector(".text-sm")?.textContent?.trim()||"";
        const val = row.querySelector(".nightRate")?.value||"";
        arr.push({date: dateTxt, value: val});
      });
      return arr;
    }
    function applyNightlyRates(nightly){
      if(!Array.isArray(nightly) || nightly.length===0) return;
      nightly.forEach(n=>{
        const rows = [...document.querySelectorAll("#nightlyGrid .grid")];
        const row = rows.find(r => (r.querySelector(".text-sm")?.textContent||"").trim() === n.date);
        if(row){
          const inp = row.querySelector(".nightRate");
          if(inp){ inp.value = n.value; }
        }
      });
      sumNightly();
    }
    function collectFormData(){
      const data = {};
      document.querySelectorAll("#calcPane input, #calcPane select, #calcPane textarea").forEach(node=>{
        if(!node.id) return;
        if(node.type === "checkbox") data[node.id] = !!node.checked;
        else data[node.id] = node.value;
      });
      data._nightly = collectNightlyRates();
      return data;
    }
    function applyFormData(data){
      if(!data || typeof data !== "object") return;
      Object.keys(data).forEach(id=>{
        if(id === "_nightly") return;
        const node = el(id);
        if(!node) return;
        if (node._flatpickr && typeof data[id] === "string" && data[id]) { try { node._flatpickr.setDate(data[id], true, "Y-m-d"); } catch(_){} return; }
        if(node.type === "checkbox") node.checked = !!data[id];
        else node.value = data[id];
      });
      compute(true);
      applyNightlyRates(data._nightly);
      compute(false);
    }
    function saveSessionNamed(name){
      if(!name){ alert("Please enter a session name."); return; }
      const all = readSessions();
      all[name] = collectFormData();
      writeSessions(all);
      alert(`Saved session: ${name}`);
      el("sessionName").value = name;
      el("sessionPicker").value = name;
    }
    function loadSessionNamed(name){
      const all = readSessions();
      if(!name || !all[name]){ alert("Choose a saved session to load."); return; }
      applyFormData(all[name]);
      alert(`Loaded session: ${name}`);
    }
    function deleteSessionNamed(name){
      const all = readSessions();
      if(!name || !all[name]){ alert("Choose a saved session to delete."); return; }
      if(!confirm(`Delete saved session "${name}"?`)) return;
      delete all[name];
      writeSessions(all);
      refreshSessionPicker();
      alert(`Deleted session: ${name}`);
    }

    // ---------- UI helpers ----------
    function resetCalculator(){
      document.querySelectorAll("#calcPane input, #calcPane textarea, #calcPane select").forEach(node=>{
        if(node.id === "channel") return;
        if(node._flatpickr){ try{ node._flatpickr.clear(); }catch(_){} return; }
        if(node.type === "checkbox") node.checked = false;
        else node.value = "";
      });
      el("nightlyGrid").innerHTML = "";
      el("rent2Sum").textContent = nzd(0);
      if (el("chargeAmendFee2")) el("chargeAmendFee2").checked = false;
      lastNewStart = ""; lastNewEnd = "";
      compute(true);
    }

    function currentChannel() {
      const v = (el("channel")?.value || "").trim();
      if (!v) return { key: "", label: "", markup: 0 };
      const [key, label, mu] = v.split("|");
      return { key, label, markup: parseFloat(mu) || 0 };
    }
    function syncMarkupsToDropdown(){
      const air = parseFloat(el('mkAirbnb')?.value||'0')/100;
      const bc  = parseFloat(el('mkBcom')?.value||'0')/100;
      const vr  = parseFloat(el('mkVrbo')?.value||'0')/100;
      const chSel = el('channel');
      if(!chSel) return;
      [...chSel.options].forEach(opt=>{
        if(opt.value.startsWith('airbnb|')) opt.value = `airbnb|Airbnb|${air}`;
        if(opt.value.startsWith('bcom|'))   opt.value = `bcom|Booking.com|${bc}`;
        if(opt.value.startsWith('vrbo|'))   opt.value = `vrbo|VRBO|${vr}`;
      });
    }
    function setInputsDisabled(containerId, disabled){
      const cont = el(containerId);
      if(!cont) return;
      cont.querySelectorAll('input, select, textarea, button').forEach(n=>{
        if(n.id === 'otaTotal1' && disabled) return;
        n.disabled = disabled;
      });
      cont.classList.toggle('disabled-soft', disabled);
    }
    function setExtensionFields(isExtension){
      const linen = el("linen2");
      const clean = el("clean2");
      if(!linen || !clean) return;

      if(isExtension){
        linen.disabled = true;
        clean.disabled = true;
        linen.classList.add("bg-gray-50");
        clean.classList.add("bg-gray-50");
        linen.classList.add("disabled-soft");
        clean.classList.add("disabled-soft");
      } else {
        linen.disabled = false;
        clean.disabled = false;
        linen.classList.remove("bg-gray-50");
        clean.classList.remove("bg-gray-50");
        linen.classList.remove("disabled-soft");
        clean.classList.remove("disabled-soft");
      }
    }

    // Direct bookings: mirror Original Linen/Cleaning into New Linen/Cleaning (auto-fill only, editable)
    function mirrorDirectLinenCleaning(direct){
      const l1 = el("linen1");
      const c1 = el("clean1");
      const l2 = el("linen2");
      const c2 = el("clean2");
      if (!l1 || !c1 || !l2 || !c2) return;

      if (direct) {
        // Always mirror original values into new
        l2.value = l1.value;
        c2.value = c1.value;

        // Lock with the same look/behaviour as Reduction of Nights (fully non-editable)
        l2.disabled = true;
        c2.disabled = true;
        l2.readOnly = true;
        c2.readOnly = true;

        l2.classList.add("bg-gray-50","disabled-soft","pointer-events-none");
        c2.classList.add("bg-gray-50","disabled-soft","pointer-events-none");
      } else {
        // Non-direct: allow editing
        l2.disabled = false;
        c2.disabled = false;
        l2.readOnly = false;
        c2.readOnly = false;

        l2.classList.remove("bg-gray-50","disabled-soft","pointer-events-none");
        c2.classList.remove("bg-gray-50","disabled-soft","pointer-events-none");
      }
    }


    function toggleNightlyBlock(show){
      const block = el("perNightBlock");
      if (!block) return;
      block.classList.toggle("hidden-soft", !show);
    }

    function setNewBookingSectionDisabled(disabled){
      const anchor = el("linen2") || el("clean2") || el("fee2");
      if(!anchor) return;
      const section = anchor.closest("section.card");
      if(!section) return;

      section.querySelectorAll("input, select, textarea, button").forEach(ctrl=>{
        // Keep hidden fields untouched
        if (ctrl.type === "hidden") return;

        // Do not disable modal buttons (outside section typically, but safe)
        if (ctrl.id === "ronlClose" || ctrl.id === "oapClose" || ctrl.id === "dmClose") return;

        ctrl.disabled = !!disabled;

        // Visual: match other disabled styling
        if (ctrl.tagName === "INPUT" || ctrl.tagName === "SELECT" || ctrl.tagName === "TEXTAREA") {
          ctrl.classList.toggle("bg-gray-50", !!disabled);
          ctrl.classList.toggle("disabled-soft", !!disabled);
        }
      });

      // Hide nightly block if disabling the section
      if (disabled) toggleNightlyBlock(false);
    }


    function setRonFields(direct, isRon, b1){
      const linen = el("linen2");
      const clean = el("clean2");
      if (!linen || !clean) return;

      if (direct && isRon && b1) {
        // mirror original linen/clean and lock with the standard disabled look
        linen.value = ((b1.linen||0)/100).toFixed(2);
        clean.value = ((b1.clean||0)/100).toFixed(2);

        linen.disabled = true;
        clean.disabled = true;
        linen.classList.add("bg-gray-50","disabled-soft");
        clean.classList.add("bg-gray-50","disabled-soft");
              linen.readOnly = true;
        clean.readOnly = true;
        linen.classList.add("pointer-events-none");
        clean.classList.add("pointer-events-none");
} else {
        // only restore if not extension (extension manages disable state)
        linen.disabled = false;
        clean.disabled = false;
        linen.classList.remove("bg-gray-50","disabled-soft");
        clean.classList.remove("bg-gray-50","disabled-soft");
              linen.readOnly = false;
        clean.readOnly = false;
        linen.classList.remove("pointer-events-none");
        clean.classList.remove("pointer-events-none");
}
    }

    function maybeShowOtaRonLimit(chKey, scenarioKey){
      if (chKey === 'direct') return;
      if (scenarioKey !== 'ron') return;
      const key = `${chKey}|ronLimit`;
      if (window.__lastRonLimitKey === key) return;
      window.__lastRonLimitKey = key;
      el('otaRonLimitModal').classList.remove('hidden');
      setTimeout(()=> el('ronlClose')?.focus(), 0);
    }


    function toggleOriginalUI(direct){
      el("obDirectFields").classList.toggle("hidden-soft", !direct);
      el("obBreakdown").classList.toggle("hidden-soft", !direct);
      setInputsDisabled("obDirectFields", !direct);
      setInputsDisabled("obBreakdown",   !direct);

      el("obOtaFields").classList.toggle("hidden-soft", direct);
      el("obOtaSummary").classList.toggle("hidden-soft", direct);
      setInputsDisabled("obOtaFields", direct);
      setInputsDisabled("obOtaSummary", direct);

      el("guestEmailCard").classList.toggle("hidden-soft", !direct);

      // Amendment fee: direct only
      const amendInp = el("chargeAmendFee2");
      const nbAmend = el("nbAmend");
      if (amendInp) {
        amendInp.disabled = !direct;
        amendInp.parentElement?.classList.toggle("disabled-soft", !direct);
      }
      if (nbAmend) nbAmend.textContent = direct ? "$0.00" : "N/A";
    }

    // ---------- Nightly inputs ----------
    function buildNightlyInputs(sOverride = null, eOverride = null) {
      const s = sOverride || getDateVal("newStart"), e = eOverride || getDateVal("newEnd");
      const grid = el("nightlyGrid");
      grid.innerHTML = "";
      el("rent2Sum").textContent = nzd(0);
      if (!s || !e || e <= s) return;

      let cur = new Date(s.getTime());
      let idx = 0;
      while (cur < e) {
        const row = document.createElement("div");
        row.className = "grid grid-cols-7 gap-2 items-center";
        row.innerHTML = `
          <div class="col-span-3 text-sm">${dtIso(cur)}</div>
          <div class="col-span-2"><input type="number" step="0.01" inputmode="decimal"
               class="nightRate mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-1"
               placeholder="Nightly rate"></div>
          <div class="col-span-2 mini">Night ${++idx}</div>`;
        grid.appendChild(row);
        cur = new Date(cur.getTime() + DAY);
      }
      grid.querySelectorAll(".nightRate").forEach((inp) => {
        inp.addEventListener("input", () => { sumNightly(); compute(false); });
        inp.addEventListener("change", () => { sumNightly(); compute(false); });
      });
    }
    function sumNightly() {
      let sum = 0;
      document.querySelectorAll("#nightlyGrid .nightRate").forEach((i) => sum += toCents(i.value));
      el("rent2Sum").textContent = nzd(sum);
      return sum;
    }

    function robustCopy(textareaId) {
      const ta = el(textareaId);
      ta.removeAttribute("readonly");
      ta.select();
      ta.setSelectionRange(0, 99999);
      let ok = false;
      try { ok = document.execCommand("copy"); } catch (_) {}
      ta.setAttribute("readonly", "");
      if (!ok && navigator.clipboard) { navigator.clipboard.writeText(ta.value).catch(() => {}); }
      alert("Copied to clipboard.");
    }

    // ---------- Scenario detection ----------
    function detectScenario(os, oe, ns, ne, propOld, propNew) {
      const hasBothProps = (propOld && propNew);
      if (hasBothProps && propOld !== propNew) return { key: 'rehouse', label: 'Rehouse', gstWaived: true };

      const origN = (os && oe) ? nightsBetween(os, oe) : 0;
      const newN  = (ns && ne) ? nightsBetween(ns, ne) : 0;
      const overlap = overlaps(os, oe, ns, ne);

      if (overlap && newN > origN) return { key: 'extension', label: 'Extension', gstWaived: false };
      if (overlap && newN < origN) return { key: 'ron', label: 'Reduction of Nights', gstWaived: false };

      return { key: 'change', label: 'Change of Date', gstWaived: false };
    }

    // ---------- Popups ----------
    function maybeShowDirectModal(chKey, os, oe, ns, ne) {
      const modal = el('directModal');
      if (!modal) return;
      if (!os || !oe || !ns || !ne) return;
      const noOverlap = !(overlaps(os, oe, ns, ne));
      const key = `${chKey}|${os?.toISOString()}|${oe?.toISOString()}|${ns?.toISOString()}|${ne?.toISOString()}`;
      if (chKey === 'direct' && noOverlap && lastDirectModalKey !== key) {
        lastDirectModalKey = key;
        modal.classList.remove('hidden');
        setTimeout(()=> el('dmClose')?.focus(), 0);
      }
    }
    function maybeShowDirect30Policy(chKey, scenarioKey, os){
      if (chKey !== 'direct' || !os) return;
      if (!(scenarioKey === 'change' || scenarioKey === 'ron')) return;
      const today = todayUTC();
      const daysToStart = Math.round((os - today) / DAY);
      if (daysToStart <= 30) {
        const key = `${chKey}|${scenarioKey}|${os.toISOString()}`;
        if (lastDirect30Key !== key) {
          lastDirect30Key = key;
          el('direct30Modal').classList.remove('hidden');
          setTimeout(()=> el('d30Close')?.focus(), 0);
        }
      }
    }

    // OTA: Extension during active stay (Airbnb/Booking.com)
    function maybeShowOtaExtWhileActive(chKey, scenarioKey, os, oe){
      if (!(chKey === 'airbnb' || chKey === 'bcom')) return;
      if (scenarioKey !== 'extension') return;
      if (!os || !oe) return;
      const today = todayUTC();
      const isActive = (today >= os) && (today < oe);
      if (!isActive) return;
      const key = `${chKey}|extActive|${os.toISOString()}|${oe.toISOString()}`;
      if (lastOtaExtKey === key) return;
      lastOtaExtKey = key;
      el('otaExtActiveModal').classList.remove('hidden');
      setTimeout(()=> el('oeaClose')?.focus(), 0);
    }

    // OTA: Change of dates must go via portal (Airbnb/Booking.com)
    function maybeShowOtaChangePortal(chKey, scenarioKey){
      if (!(chKey === 'airbnb' || chKey === 'bcom')) return;
      if (scenarioKey !== 'change') return;
      const key = `${chKey}|changePortal`;
      if (lastOtaChangeKey === key) return;
      lastOtaChangeKey = key;
      el('otaChangePortalModal').classList.remove('hidden');
      setTimeout(()=> el('ocpClose')?.focus(), 0);
    }

    // OTA: Approval modal inside free-cancellation window
    function maybeShowOtaApproval(chKey, scenarioKey, os){
      if (!(chKey === 'airbnb' || chKey === 'bcom')) return;
      if (!(scenarioKey === 'change' || scenarioKey === 'ron')) return;
      if (!os) return;
      const today = todayUTC();
      const daysToStart = Math.round((os - today) / DAY);
      const threshold = (chKey === 'bcom') ? 7 : 30;
      if (daysToStart > threshold) return;
      const key = `${chKey}|approv|${scenarioKey}|${os.toISOString()}`;
      if (lastOtaApprovalKey === key) return;
      lastOtaApprovalKey = key;
      // Set dynamic labels
      el('oap-chan').textContent = (chKey === 'bcom') ? 'Booking.com' : 'Airbnb';
      el('oap-type').textContent = (scenarioKey === 'ron') ? 'Reduction of Nights' : 'Change of Date';
      el('otaApprovalModal').classList.remove('hidden');
      setTimeout(()=> el('oapClose')?.focus(), 0);
    }

    // ---------- Main compute ----------
    function compute(rebuildDates = true) {
      // Dates & nights
      const os = getDateVal("origStart"), oe = getDateVal("origEnd");
      const ns = getDateVal("newStart"), ne = getDateVal("newEnd");
      const origN = (os && oe) ? nightsBetween(os, oe) : 0;
      const newN  = (ns && ne) ? nightsBetween(ns, ne) : 0;
      el("origNights").textContent = origN;
      el("newNights").textContent  = newN;

      const ch = currentChannel();
      const direct = ch.key === 'direct';
      toggleOriginalUI(direct);

      // Modals
      maybeShowDirectModal(ch.key, os, oe, ns, ne);

      // Settings/toggles
      const ownerGSTRate = parseFloat(el("ownerGSTRate")?.value || "0.15");
      const bookingFeeRate = parseFloat(el("bookingFeeRate")?.value || "0.071");
      const amendFeeEachC = toCents(el("amendFeeEach")?.value || "28.75");
      const chargeAmendFee = !!el("chargeAmendFee2")?.checked;
      const includeOwnerGST = false;

      // Properties
      const propOld = (el("propIdOld")?.value || "").trim();
      const propNew = (el("propIdNew")?.value || "").trim();

      

      // Scenario (needed for extension rules)
      const scen = detectScenario(os, oe, ns, ne, propOld, propNew);
      const isExtension = scen.key === 'extension';
      // Extension: hide Linen/Cleaning rows in New Booking summary breakdown
      const nbLinenRow = el("nbLinen")?.closest(".row");
      const nbCleanRow = el("nbClean")?.closest(".row");
      if (nbLinenRow) nbLinenRow.style.display = isExtension ? 'none' : '';
      if (nbCleanRow) nbCleanRow.style.display = isExtension ? 'none' : '';

      // Extension: hide Linen/Cleaning everywhere in New Booking breakdown
      document.querySelectorAll('.nb-ext-hide').forEach(r => {
        r.style.display = isExtension ? 'none' : '';
      });

      // Hide Linen/Cleaning rows for Extensions (New Booking only)
      document.querySelectorAll('.nb-lc-row').forEach(r => {
        r.style.display = isExtension ? 'none' : '';
      });

      const isRon = scen.key === 'ron';

      // Nightly inputs:
      // - Extension: only the added nights (original check-out to new check-out)
      // - Other scenarios: full new date range (new start to new end)
      const nightlyStart = (isExtension && oe) ? oe : ns;
      const nightlyEnd   = ne;

      // Update hint text
      const hint = el("nightlyHint");
      if (hint) {
        hint.innerHTML = (direct && isRon)
          ? 'Reduction of Nights (Bachcare Direct): New rent is <b>auto-calculated</b> from the original Rent (incl. GST + GEL).'
          : isExtension
          ? 'Enter the <b>nightly rates for the extension nights only</b> (from original check-out to new check-out).'
          : 'Set <b>New Start</b> and <b>New End</b> dates to generate one input per night.';
      }

      // Rebuild nightly grid if needed (based on the effective nightly range)
      if (rebuildDates) {
        const key = `${nightlyStart ? dtIso(nightlyStart) : ""}|${nightlyEnd ? dtIso(nightlyEnd) : ""}|${scen.key}`;
        if (key !== lastNightlyKey) {
          buildNightlyInputs(nightlyStart, nightlyEnd);
          lastNightlyKey = key;
        }
      }

      // Extension: linen/cleaning are not charged
      setExtensionFields(isExtension);
// Original booking (Direct) — GEL removed
      const b1 = {
        rent: toCents(el("rent1").value),
        linen: toCents(el("linen1").value),
        clean: toCents(el("clean1").value),
        fee: toCents(el("fee1").value),
        addInfo: (el("addInfo1").value || "").trim(),
        addAmt: toCents(el("addAmt1").value)
      };

      // Direct: auto-fill New Linen/Cleaning from Original values
      mirrorDirectLinenCleaning(direct);

      const gel1 = 0;

      // New booking (sum nightly)
      let rent2 = sumNightly();

      // Reduction of Nights (Bachcare Direct): hide nightly inputs and auto-calculate rent based on original rent incl GST+GEL
      if (direct && isRon) {
        toggleNightlyBlock(false);
        el("nightlyGrid").innerHTML = "";
        // Original rent input is treated as: Rent + GST + GEL (inclusive total)
        const origRentInclC = toCents(el("rent1").value);
        const origGelC = origN * GEL_PER_NIGHT_C;
        const rentPlusGstC = Math.max(0, origRentInclC - origGelC);
        const rentExGstC = origN > 0 ? Math.round(rentPlusGstC / (1 + ownerGSTRate)) : 0;
        const perNightRentExGstC = origN > 0 ? (rentExGstC / origN) : 0;
        rent2 = Math.round(perNightRentExGstC * newN);
        el("rent2Sum").textContent = nzd(rent2);
      } else {
        toggleNightlyBlock(true);
      }
      const gel2Nights = (isExtension && oe && ne) ? nightsBetween(oe, ne) : ((ns && ne) ? nightsBetween(ns, ne) : 0);
      const gel2 = gel2Nights * GEL_PER_NIGHT_C;

      // Booking Fee auto
      const rent2GstC_forFee = Math.round(rent2 * ownerGSTRate);
      const rent2InclGstC_forFee = rent2 + rent2GstC_forFee;
      const fee2RawC = Math.round(rent2InclGstC_forFee * (isFinite(bookingFeeRate) ? bookingFeeRate : 0));
      const fee2 = Math.min(fee2RawC, BOOKING_FEE_CAP_C);

      const b2 = {
        rent: rent2,
        linen: direct ? b1.linen : toCents(el("linen2").value),
        clean: direct ? b1.clean : toCents(el("clean2").value),
        fee: fee2,
        addInfo: (el("addInfo2").value || "").trim(),
        addAmt: toCents(el("addAmt2").value)
      };

      // Linen/Cleaning are shown for Direct, but should not be charged again on Extensions
      const lc2ChargeC = isExtension ? 0 : (b2.linen + b2.clean);


      // Apply Reduction of Nights UI (Direct only)
      setRonFields(direct, isRon, b1);


      // Markups (GST influences markup base)
      const ownerGST1C_forMarkup = Math.round(b1.rent * ownerGSTRate);
      const ownerGST2C_forMarkup = Math.round(b2.rent * ownerGSTRate);
      const markup1C = Math.round((b1.rent + ownerGST1C_forMarkup + b1.fee + gel1) * ch.markup);
      const markup2C = Math.round((b2.rent + ownerGST2C_forMarkup + b2.fee + gel2) * ch.markup);

      // Owner GST (included in New Booking Total)
      const ownerGST2C = Math.round(b2.rent * ownerGSTRate);

      // Amendment (direct only)
      const amendTotalC = direct && chargeAmendFee ? amendFeeEachC : 0;

      // Totals
      let total1;
      if (direct) {
        total1 = b1.rent + b1.linen + b1.clean + b1.fee + b1.addAmt + markup1C;
      } else {
        const otaC = toCents(el("otaTotal1")?.value || 0);
        total1 = otaC;
      }
      const total2Base = b2.rent + ownerGST2C + lc2ChargeC + b2.fee + b2.addAmt + gel2 + markup2C + amendTotalC;
      const extensionChargesC = total2Base;
      const total2 = isExtension ? (total1 + extensionChargesC) : total2Base;
      const diff   = total2 - total1;

      // Scenario
      el("scenarioBadge").textContent = scen.label;

      // Show policy popups
      maybeShowDirect30Policy(ch.key, scen.key, os);
      maybeShowOtaExtWhileActive(ch.key, scen.key, os, oe);
      maybeShowOtaChangePortal(ch.key, scen.key);
      maybeShowOtaApproval(ch.key, scen.key, os);
      maybeShowOtaRonLimit(ch.key, scen.key);

      // Non-Direct: lock the entire New Booking section for Reduction of Nights
      if (!direct && isRon) {
        setNewBookingSectionDisabled(true);
      } else if (!(direct && isRon)) {
        // For Direct + RON, keep linen/clean locked by setRonFields()
        setNewBookingSectionDisabled(false);
      }

      // UI breakdowns
            // Direct: always mirror + lock New Linen/Cleaning from Original (after any scenario UI changes)
      mirrorDirectLinenCleaning(direct);

// Labels for Additional Charge rows
      const obLbl = (b1.addInfo && b1.addInfo.trim()) ? b1.addInfo.trim() : "Additional Charge";
      const nbLbl = (b2.addInfo && b2.addInfo.trim()) ? b2.addInfo.trim() : "Additional Charge";
      if (el("obAddLabel")) el("obAddLabel").textContent = obLbl;
      if (el("nbAddLabel")) el("nbAddLabel").textContent = nbLbl;

      el("obRent").textContent   = nzd(b1.rent);
      el("obLinen").textContent  = nzd(b1.linen);
      el("obClean").textContent  = nzd(b1.clean);
      el("obFee").textContent    = nzd(b1.fee);
      el("obAdd").textContent    = nzd(b1.addAmt);
      el("obMarkup").textContent = nzd(markup1C);
      el("obOtaTotal").textContent = nzd(total1);

      el("nbRent").textContent   = nzd(b2.rent);
      el("nbLinen").textContent  = nzd(b2.linen);
      el("nbClean").textContent  = nzd(b2.clean);
      el("nbFee").textContent    = nzd(b2.fee);
      el("nbAdd").textContent    = nzd(b2.addAmt);
      el("gelAuto2").textContent = nzd(gel2);
      el("nbMarkup").textContent = nzd(markup2C);
      el("ownerGST2").textContent = nzd(ownerGST2C);
      el("nbAmend").textContent = direct ? (amendTotalC > 0 ? nzd(amendTotalC) : "Waived") : "N/A";

      el("total1").textContent   = nzd(total1);
      el("total2").textContent   = nzd(total2);
      el("tile1").textContent = nzd(total1);
      el("tile2").textContent = nzd(total2);
      el("tile3").textContent = nzd(Math.abs(diff));
      el("tile3label").textContent = diff >= 0 ? "Amount to charge guest" : "Amount to refund guest";
      el("tile3desc").textContent  = diff >= 0 ? "Collect this amount" : "Refund this amount";

      // ---- Finance Breakdown (HTML + Preview) ----
      const header =
        "<b>Booking Breakdown</b><br>" +
        `<b>Property ID:</b> ${el("propIdOld")?.value || ""}<br>` +
        `<b>Channel:</b> ${ch.label} (Markup ${(ch.markup * 100).toFixed(1)}%)<br>` +
        `<b>Scenario:</b> ${scen.label}<br><br>`;

      const origNights = (os && oe) ? nightsBetween(os, oe) : 0;
      const newNights  = (ns && ne) ? nightsBetween(ns, ne) : 0;
      const origDatesLine = (os && oe) ? `Check-in: ${dtNZ(os)} &nbsp;|&nbsp; Check-out: ${dtNZ(oe)} &nbsp;|&nbsp; Nights: ${origNights}<br>` : "";
      const newDatesLine  = (ns && ne) ? `Check-in: ${dtNZ(ns)} &nbsp;|&nbsp; Check-out: ${dtNZ(ne)} &nbsp;|&nbsp; Nights: ${newNights}<br>` : "";

            const obAddLabel = (b1.addInfo && b1.addInfo.trim()) ? b1.addInfo.trim() : "Additional Charge";
      const nbAddLabel = (b2.addInfo && b2.addInfo.trim()) ? b2.addInfo.trim() : "Additional Charge";
const originalHtml = (ch.key === 'direct')
        ? "<b>Original Booking</b><br>" +
          origDatesLine +
          `Rent: ${nzd(b1.rent)}<br>` +
          `Linen: ${nzd(b1.linen)}<br>` +
          `Cleaning: ${nzd(b1.clean)}<br>` +
          `Booking Fee: ${nzd(b1.fee)}<br>
        ${b1.addAmt ? `${obAddLabel}: ${nzd(b1.addAmt)}<br>` : ''}` +
          `Total: ${nzd(total1)}<br><br>`
        : "<b>Original Booking</b><br>" +
          origDatesLine +
          `Total Holiday Cost: ${nzd(total1)}<br><br>`;

      const newHtml =
        (isExtension ? "<b>Extension Charges</b><br>" : "<b>New Booking</b><br>") +
        newDatesLine +
        `Rent Total: ${nzd(b2.rent)}<br>
        ${isExtension ? '' : `Linen: ${nzd(b2.linen)}<br>Cleaning: ${nzd(b2.clean)}<br>`}` +
        `Owner GST Total: ${nzd(ownerGST2C)}<br>` +
        `GEL: ${nzd(gel2)}<br>` +
        `Channel Markup: ${nzd(markup2C)}<br>` +
        `` +
        `` +
        `Booking Fee: ${nzd(b2.fee)}<br>
        ${b2.addAmt ? `${nbAddLabel}: ${nzd(b2.addAmt)}<br>` : ''}` +
        (direct ? (amendTotalC>0?`Amendment Fee: ${nzd(amendTotalC)}<br>`:`Amendment Fee: Waived<br>`) : `Amendment Fee: N/A<br>`) +
        (isExtension
          ? `Extension Total: ${nzd(extensionChargesC)}<br>Updated Booking Total: ${nzd(total2)}<br><br>`
          : `Total: ${nzd(total2)}<br><br>`);


      const outcomeHtml = diff >= 0
        ? `Amount to charge guest: ${nzd(diff)}<br>`
        : `Amount to refund guest: ${nzd(-diff)}<br>`;

      const html = header + originalHtml + newHtml + "<b>Outcome</b><br>" + outcomeHtml;
      el("htmlCOD").value = html;
      el("previewCOD").innerHTML = html;

      // ---- Direct-only pre-drafted email (unchanged from v1.0) ----
      if (direct) {
        const ownerGSTRate = parseFloat(el("ownerGSTRate").value||"0.15");
        const rentOriginalEmailC = b1.rent + (includeOwnerGST ? Math.round(b1.rent*ownerGSTRate) : 0);
        const rentNewEmailC = b2.rent + gel2 + (includeOwnerGST ? Math.round(b2.rent*ownerGSTRate) : 0);
        const phrase = scen.label.toLowerCase();

        const email =
`Subject: Updated Booking Quote – Bachcare Direct

Hi there,

Thank you for your ${phrase} request. Please find a clear comparison of your original booking and the updated booking below.

This quote is valid for 24 hours. Please give us a call to confirm so we can process the ${diff>=0?'payment':'refund'} accordingly.

Original Booking
Dates: ${dtNZ(os)} to ${dtNZ(oe)}
Total: ${nzd(total1)}

Updated Booking
Dates: ${dtNZ(ns)} to ${dtNZ(ne)}
Total: ${nzd(total2)}

${diff >= 0 ? `Amount to charge: ${nzd(diff)} once you confirm.` : `Amount to refund: ${nzd(-diff)} once you confirm.`}

Kind regards,
Bachcare Support Team`;

        el("guestEmail").value = email;
      } else {
        el("guestEmail").value = "";
      }

      // Reflect fee2 read-only
      el("fee2").value = (b2.fee / 100).toFixed(2);
    }

    // ---------- Calendars ----------
    function attachCalendars() {
      const opts = { altInput:true, altFormat:"d/m/Y", dateFormat:"Y-m-d", allowInput:true, onChange: () => compute(true) };
      if (window.flatpickr) {
        flatpickr("#origStart", opts);
        flatpickr("#origEnd",   opts);
        flatpickr("#newStart",  opts);
        flatpickr("#newEnd",    opts);
      }
    }

    // ---------- Tabs ----------
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        document.getElementById('calcPane').classList.add('hidden');
        document.getElementById('settingsPane').classList.add('hidden');
        document.getElementById('sessionsPane').classList.add('hidden');
        document.getElementById(target).classList.remove('hidden');
      });
    });

    // ---------- Init ----------
    (function init() {
      // Force platform to be selected each time (avoid browser restoring last value)
      el("channel").value = "";
      updatePlatformLock();

      el("channel").addEventListener("change", ()=>{
        updatePlatformLock(); updatePlatformLock(); updatePlatformLock();
      updatePlatformLock();
      recompute();
});

      attachCalendars();
      // sync markups shown in dropdown labels from Settings
      (function syncMarkupsToDropdown(){
        const air = parseFloat(el('mkAirbnb')?.value||'0')/100;
        const bc  = parseFloat(el('mkBcom')?.value||'0')/100;
        const vr  = parseFloat(el('mkVrbo')?.value||'0')/100;
        const chSel = el('channel');
        if(!chSel) return;
        [...chSel.options].forEach(opt=>{
          if(opt.value.startsWith('airbnb|')) opt.value = `airbnb|Airbnb|${air}`;
          if(opt.value.startsWith('bcom|'))   opt.value = `bcom|Booking.com|${bc}`;
          if(opt.value.startsWith('vrbo|'))   opt.value = `vrbo|VRBO|${vr}`;
        });
      })();

      // Inputs that recompute
      ["channel","ownerGSTRate","bookingFeeRate","amendFeeEach","linen1","clean1","rent1","fee1","addInfo1","addAmt1","otaTotal1","linen2","clean2","addInfo2","addAmt2","propIdOld","propIdNew","chargeAmendFee2","includeOwnerGST"]
        .forEach(id => { const n = el(id); if (n) { n.addEventListener("input", () => compute(false)); n.addEventListener("change", () => compute(false)); } });

      // Dates trigger recompute WITH nightly grid rebuild
      ["origStart","origEnd","newStart","newEnd"]
        .forEach(id => { const n = el(id); if (n) { n.addEventListener("input", () => compute(true)); n.addEventListener("change", () => compute(true)); } });

      // Modal closes
      el('dmClose')?.addEventListener('click', ()=> el('directModal').classList.add('hidden'));
      el('d30Close')?.addEventListener('click', ()=> el('direct30Modal').classList.add('hidden'));
      el('oeaClose')?.addEventListener('click', ()=> el('otaExtActiveModal').classList.add('hidden'));
      el('ocpClose')?.addEventListener('click', ()=> el('otaChangePortalModal').classList.add('hidden'));
      el('oapClose')?.addEventListener('click', ()=> el('otaApprovalModal').classList.add('hidden'));
      el('ronlClose')?.addEventListener('click', ()=> el('otaRonLimitModal').classList.add('hidden'));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){
        el('directModal')?.classList.add('hidden');
        el('direct30Modal')?.classList.add('hidden');
        el('otaExtActiveModal')?.classList.add('hidden');
        el('otaChangePortalModal')?.classList.add('hidden');
        el('otaApprovalModal')?.classList.add('hidden');
        el('otaRonLimitModal')?.classList.add('hidden');
      }});

      // Copy buttons
      el("copyCOD").addEventListener("click", () => robustCopy("htmlCOD"));
      el("copyGuestEmail").addEventListener("click", () => robustCopy("guestEmail"));

      // Sessions
      refreshSessionPicker();
      el("sessionSave").addEventListener("click", ()=> saveSessionNamed(el("sessionName").value.trim() || el("sessionPicker").value.trim()));
      el("sessionLoad").addEventListener("click", ()=> loadSessionNamed(el("sessionPicker").value.trim() || el("sessionName").value.trim()));
      el("sessionDelete").addEventListener("click", ()=> deleteSessionNamed(el("sessionPicker").value.trim() || el("sessionName").value.trim()));

      // Reset
      el("resetBtn").addEventListener("click", resetCalculator);

      // First compute
      compute(true);
    })();
  </script>
</body>
</html>
