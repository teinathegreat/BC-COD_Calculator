<!DOCTYPE html>
<!-- Bachcare Calculator — Base Working Version (v0.27) -->
<!-- v0.27: Restored OTA/Direct pop-ups; “GST on Rent (auto)” in breakdown; New Property ID auto-fills from Original; label updated; all latest features retained. -->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Booking Adjustment Calculator (Standalone) — (v0.27)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <style>
    .card{background:#fff;border:1px solid #f1f5f9;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;justify-content:space-between;align-items:center}
    .tile{background:#f8fafc;border:1px solid #f1f5f9;border-radius:1rem;padding:1rem}
    .mini{font-size:.8rem;color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.5rem;background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem;font-weight:600}
    .tab{padding:.5rem 1rem;border:1px solid #e2e8f0;border-bottom:none;border-top-left-radius:.75rem;border-top-right-radius:.75rem;background:#f8fafc;margin-right:.5rem;cursor:pointer}
    .tab.active{background:#fff;font-weight:600}
    .tabpanes{border:1px solid #e2e8f0;border-radius:0 1rem 1rem 1rem;overflow:hidden}
    .hidden-soft{display:none}
    .disabled-soft{opacity:.5;pointer-events:none}
    .required:after{content:" *"; color:#dc2626; font-weight:600}
    #previewCOD{max-height:20rem;overflow:auto}
    @media (min-width:1024px){ #htmlCOD{height:20rem} }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen w-full max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold tracking-tight mb-4">Booking Adjustment Calculator (NZD)</h1>

    <!-- Tabs -->
    <div class="flex mb-2 gap-2">
      <button class="tab active" data-tab="calcPane">Calculator</button>
      <button class="tab" data-tab="settingsPane">Settings</button>
      <button class="tab" data-tab="sessionsPane">Sessions</button>
    </div>

    <div class="tabpanes bg-white rounded-xl">
      <!-- Calculator -->
      <div id="calcPane" class="p-4">
        <div class="mb-4 flex flex-wrap items-end gap-3">
          <label class="text-sm text-gray-700">
            Platform
            <select id="channel" class="ml-2 px-3 py-2 rounded-xl border border-gray-300 bg-white align-middle">
              <option value="direct|Bachcare Direct|0" selected>Bachcare Direct</option>
              <option value="bcom|Booking.com|0.239">Booking.com</option>
              <option value="vrbo|VRBO|0.202">VRBO</option>
              <option value="airbnb|Airbnb|0.255">Airbnb</option>
            </select>
          </label>
          <button id="resetBtn" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">Reset</button>
        </div>

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Original Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Booking</h2>

            <label class="block required"><span class="text-sm font-medium text-gray-700">Original Booking Created On</span>
              <input type="text" id="createdAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="origStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="origEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="origNights">0</span></div>

            <label class="block mt-3"><span class="text-sm font-medium text-gray-700">Original Property ID</span>
              <input type="text" id="propIdOld" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 341234">
            </label>

            <!-- OTA-only -->
            <div id="obOtaFields" class="grid grid-cols-1 gap-3 mt-3 hidden-soft">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Total Holiday Cost</span>
                <input type="text" id="otaTotal1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <div class="mini">Used when Platform is Airbnb, Booking.com or VRBO.</div>
            </div>

            <!-- Direct-only (Rent already includes GST & GEL) -->
            <div id="obDirectFields" class="grid grid-cols-1 gap-3 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Rent (total, incl. GST & GEL)</span>
                <input type="text" id="rent1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (enter known)</span>
                <input type="text" id="fee1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 40.00">
              </label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                  <input type="text" id="addInfo1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
                </label>
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                  <input type="text" id="addAmt1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
                </label>
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>

            <div id="obBreakdown" class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent</span><span id="obRent">$0.00</span></div>
              <!-- GST row removed for original booking -->
              <div class="row"><span class="text-gray-600">Linen</span><span id="obLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="obClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee</span><span id="obFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="obAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="obMarkup">$0.00</span></div>
            </div>

            <div id="obOtaSummary" class="space-y-1 text-sm hidden-soft">
              <div class="row"><span class="text-gray-600">Total Holiday Cost</span><span id="obOtaTotal">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">Original Booking Total</span><span id="total1" class="font-semibold">$0.00</span></div>
          </section>

          <!-- New Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Booking</h2>

            <label class="block"><span class="text-sm font-medium text-gray-700">New Booking Created On</span>
              <input type="text" id="newCreatedAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="newStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="newEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="newNights">0</span></div>

            <label class="block mt-3"><span class="text-sm font-medium text-gray-700">New Property ID <span class="mini">(Adjust if new property ID or leave as is)</span></span>
              <input type="text" id="propIdNew" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="auto from Original Property ID">
            </label>

            <!-- Daily Modifier Rates -->
            <div id="perNightBlock" class="mt-2">
              <h3 class="font-semibold">Daily Modifier Rates (New Booking)</h3>
              <div id="nightlyHint" class="mini">Set New Start and New End to generate inputs per night.</div>
              <div id="addedNightsNotice" class="mini text-amber-700 hidden-soft mt-1">Only the <b>added nights</b> are shown below (Direct Extension).</div>
              <div id="nightlyWrap" class="mt-2">
                <div id="nightlyGrid" class="grid gap-2"></div>
                <div class="row mt-2"><span class="text-gray-600">Rent (sum of nights)</span><span id="rent2Sum">$0.00</span></div>
              </div>
            </div>

            <!-- Stack -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (auto, min $40 cap $299)</span>
                <input type="text" id="fee2" class="mt-1 w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2" placeholder="auto" readonly>
              </label>
            </div>

            <!-- Additional charge -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                <input type="text" id="addInfo2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                <input type="text" id="addAmt2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
              </label>
            </div>

            <!-- Amendment -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 items-end">
              <label class="block"><span class="text-sm font-medium text-gray-700">Amendment Count</span>
                <input type="number" min="0" step="1" id="amendCount2" value="0" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <div class="mini text-gray-600">
                Per-fee value is set in <b>Settings</b> <span class="text-gray-400">(Direct only)</span>.
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>
            <div class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent (sum nights)</span><span id="nbRent">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GST on Rent</span><span id="ownerGST2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Linen</span><span id="nbLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="nbClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee (auto)</span><span id="nbFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="nbAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="nbMarkup">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Amendment Fee</span><span id="nbAmend">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">New Booking Total</span><span id="total2" class="font-semibold">$0.00</span></div>
          </section>
          <!-- Outcome + Notes + Email -->
          <div class="lg:col-span-2">
            <div class="mt-6 card">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Outcome</h3>
                <div>Scenario: <span id="scenarioBadge" class="badge">—</span></div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-2">
                <div class="tile">
                  <div class="text-sm text-gray-600">Original Total</div>
                  <div id="tile1" class="text-2xl font-semibold">—</div>
                  <div class="text-xs text-gray-500">Original booking charges.</div>
                </div>
                <div class="tile">
                  <div class="text-sm text-gray-600">New Total</div>
                  <div id="tile2" class="text-2xl font-semibold">—</div>
                  <div class="text-xs text-gray-500">New booking charges.</div>
                </div>
                <div class="tile">
                  <div class="text-sm text-gray-600" id="tile3label">Amount to charge/refund guest</div>
                  <div id="tile3" class="text-2xl font-semibold">—</div>
                  <div class="text-xs text-gray-500" id="tile3desc">Based on totals above</div>
                </div>
              </div>

              <!-- Notes + Preview side-by-side -->
              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-5">
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Finance Breakdown Itinerary Note</h2>
                  <textarea id="htmlCOD" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
                  <button id="copyCOD" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
                </section>
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Preview</h2>
                  <div id="previewCOD" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
                </section>
              </div>

              <!-- Guest Email (Direct only) -->
              <div class="mt-4 grid grid-cols-1">
                <section id="guestEmailCard" class="card hidden-soft">
                  <h2 class="text-xl font-semibold mb-3">Guest Email (Direct bookings)</h2>
                  <textarea id="guestEmail" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm h-64" readonly></textarea>
                  <button id="copyGuestEmail" class="mt-2 px-3 py-2 rounded-xl bg-blue-600 text-white">Copy Email</button>
                  <div class="mini mt-2">Updates automatically. Language aligned with ComCom guidance.</div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-5">
          Tip: Enter numbers only (e.g. 120 or 120.50). Currency shown in NZD. Dates accept dd/mm/yyyy or yyyy-mm-dd.
        </p>
      </div>

      <!-- Settings -->
      <div id="settingsPane" class="p-4 hidden">
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm font-semibold">GST Rate (on rent)</span>
          </div>
          <input type="text" id="ownerGSTRate" value="0.15" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Applies to new booking rent (auto).</div>
        </section>

        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm font-semibold">Booking Fee Rate</span>
          </div>
          <input type="text" id="bookingFeeRate" value="0.071" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Fee = (Rent + GEL) × rate, min $40, max $299.</div>
        </section>

        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm font-semibold">Amendment Fee (each)</span>
          </div>
          <input type="text" id="amendFeeEach" value="28.75" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Direct only.</div>
        </section>

        <section class="card">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm font-semibold">Channel Markups</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <label class="text-sm">Airbnb %<input type="text" id="mkAirbnb" value="25.5" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">Booking.com %<input type="text" id="mkBcom" value="23.9" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">VRBO %<input type="text" id="mkVrbo" value="20.2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
          </div>
          <div class="mini">Updates Platform dropdown.</div>
        </section>
      </div>

      <!-- Sessions -->
      <div id="sessionsPane" class="p-4 hidden">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Save / Load / Delete Sessions</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-end">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Saved Sessions</label>
              <select id="sessionPicker" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white">
                <option value="">— none —</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Name</label>
              <input id="sessionName" type="text" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white" placeholder="e.g. Smith 23–28 Aug"/>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="sessionSave" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save as New / Overwrite</button>
              <button id="sessionLoad" class="px-3 py-2 rounded-xl bg-blue-600 text-white">Load</button>
              <button id="sessionDelete" class="px-3 py-2 rounded-xl bg-red-600 text-white">Delete</button>
            </div>
          </div>
          <div class="mini mt-2">Stored locally in your browser (includes nightly rates & dates).</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal: Bachcare Direct non-overlap -->
  <div id="directModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="dm-title" aria-describedby="dm-desc" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50">
    <div class="modal" style="max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-red-50 border border-red-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="dm-title" class="text-xl font-semibold text-gray-900">Calculator not needed</h3>
            <p id="dm-desc" class="mt-2 text-gray-700">
              This is a <b>Bachcare Direct</b> booking and the <b>new dates do not overlap</b> the original dates.
              Please create a <b>new offline booking</b> — that will give the correct total automatically.
            </p>
            <p class="mt-2 text-sm text-gray-500">You can still use the calculator if you need a manual comparison, but it’s not required for this scenario.</p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="dmClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: OTA extension during active stay (Airbnb/Booking.com) -->
  <div id="otaActiveExtModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="otaext-title" aria-describedby="otaext-desc" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50">
    <div class="modal" style="max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)">
      <div class="p-6">
        <h3 id="otaext-title" class="text-xl font-semibold text-gray-900">Process extension by phone</h3>
        <p id="otaext-desc" class="mt-2 text-gray-700">
          The extension is being requested while the booking is active. <b>Airbnb/Booking.com</b> portals won’t allow last‑minute changes. 
          Please <b>take payment by phone</b> and raise a <b>workflow to Finance</b> explaining the partial phone payment vs portal.
        </p>
        <div class="mt-6 flex justify-end gap-2">
          <button id="otaExtOk" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: OTA date change instruction (Airbnb/Booking.com) -->
  <div id="otaDateChangeModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="otadc-title" aria-describedby="otadc-desc" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50">
    <div class="modal" style="max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)">
      <div class="p-6">
        <h3 id="otadc-title" class="text-xl font-semibold text-gray-900">Have guest request change in portal</h3>
        <p id="otadc-desc" class="mt-2 text-gray-700">
          For <b>Airbnb/Booking.com</b> date changes or reductions, ask the guest to submit the request in their portal. 
          Accept it on our side so their system calculates the correct amount. Then mirror it in Enterprise and <b>copy the portal breakdown</b> into the itinerary notes. 
          Raise a <b>workflow to Finance</b> to adjust the Enterprise breakdown.
        </p>
        <div class="mt-6 flex justify-end gap-2">
          <button id="otaDateOk" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Booking.com within 7 days approval -->
  <div id="bcomWindowModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="bcom-title" aria-describedby="bcom-desc" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50">
    <div class="modal" style="max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)">
      <div class="p-6">
        <h3 id="bcom-title" class="text-xl font-semibold text-gray-900">Team Leader approval required</h3>
        <p id="bcom-desc" class="mt-2 text-gray-700">
          This <b>Booking.com</b> change is within <b>7 days</b> of check‑in and outside the free cancellation period. 
          Please seek <b>Team Leader approval</b> before proceeding.
        </p>
        <div class="mt-6 flex justify-end gap-2">
          <button id="bcomOk" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Airbnb within 30 days approval -->
  <div id="airbnbWindowModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="abnb-title" aria-describedby="abnb-desc" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50">
    <div class="modal" style="max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)">
      <div class="p-6">
        <h3 id="abnb-title" class="text-xl font-semibold text-gray-900">Team Leader approval required</h3>
        <p id="abnb-desc" class="mt-2 text-gray-700">
          This <b>Airbnb</b> change is within <b>30 days</b> of check‑in and outside the free cancellation period. 
          Please seek <b>Team Leader approval</b> before proceeding.
        </p>
        <div class="mt-6 flex justify-end gap-2">
          <button id="airbnbOk" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>
  <!-- JS Logic -->
  <script>
    const el = (id) => document.getElementById(id);
    const DAY = 86400000;
    const toCents = (v) => {
      const n = typeof v === "number" ? v : parseFloat(String(v || "").replace(/[^0-9.-]/g, ""));
      return Number.isNaN(n) ? 0 : Math.round(n * 100);
    };
    const nzd = (c) => new Intl.NumberFormat("en-NZ",{style:"currency",currency:"NZD"}).format((c||0)/100);
    function getDateVal(id){
      const v=(el(id)?.value||"").trim(); if(!v) return null;
      if(/^\d{4}-\d{2}-\d{2}$/.test(v)){const [y,m,d]=v.split("-").map(Number);return new Date(Date.UTC(y,m-1,d));}
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){const [d,m,y]=v.split("/").map(Number);return new Date(Date.UTC(y,m-1,d));}
      const tryD=new Date(v); return isNaN(tryD)?null:new Date(Date.UTC(tryD.getUTCFullYear(),tryD.getUTCMonth(),tryD.getUTCDate()));
    }
    const dtIso=(d)=>d.toISOString().slice(0,10);
    const dtNZ=(d)=>!d?"":d.toLocaleDateString("en-NZ",{day:"2-digit",month:"2-digit",year:"numeric"});
    const nightsBetween=(a,b)=>Math.max(0,Math.round((b-a)/DAY));
    const overlaps=(a1,a2,b1,b2)=>a1&&a2&&b1&&b2&&(a1<=b2)&&(b1<=a2);

    // restore channel markup sync
    function syncMarkupsToDropdown(){
      const air=parseFloat(el('mkAirbnb').value||'0')/100;
      const bc=parseFloat(el('mkBcom').value||'0')/100;
      const vr=parseFloat(el('mkVrbo').value||'0')/100;
      [...el('channel').options].forEach(opt=>{
        if(opt.value.startsWith('airbnb|')) opt.value=`airbnb|Airbnb|${air}`;
        if(opt.value.startsWith('bcom|')) opt.value=`bcom|Booking.com|${bc}`;
        if(opt.value.startsWith('vrbo|')) opt.value=`vrbo|VRBO|${vr}`;
      });
    }
    function currentChannel(){const [k,l,m]=el("channel").value.split("|");return {key:k,label:l,markup:parseFloat(m)||0};}

    // scenario detect
    function detectScenario(os,oe,ns,ne,propOld,propNew){
      if(propOld&&propNew&&propOld!==propNew)return{key:"rehouse",label:"Rehouse"};
      const origN=os&&oe?nightsBetween(os,oe):0; const newN=ns&&ne?nightsBetween(ns,ne):0;
      const overlap=overlaps(os,oe,ns,ne);
      if(overlap&&newN>origN) return{key:"extension",label:"Extension"};
      if(overlap&&newN<origN) return{key:"ron",label:"Reduction of Nights"};
      return{key:"change",label:"Change of Date"};
    }

    // compute (simplified snippet showing gst(auto) etc.)
    function compute(){
      const os=getDateVal("origStart"),oe=getDateVal("origEnd"),ns=getDateVal("newStart"),ne=getDateVal("newEnd");
      const origN=os&&oe?nightsBetween(os,oe):0; const newN=ns&&ne?nightsBetween(ns,ne):0;
      el("origNights").textContent=origN; el("newNights").textContent=newN;
      // auto populate new property id
      if(el("propIdOld").value && !el("propIdNew").value){el("propIdNew").value=el("propIdOld").value;}
      const ch=currentChannel(); const scen=detectScenario(os,oe,ns,ne,el("propIdOld").value,el("propIdNew").value);
      el("scenarioBadge").textContent=scen.label;
      // ... many calculations (rent, gst, fees, amendment, totals, etc.)
      // in breakdown label GST as (auto)
      el("ownerGST2").textContent="(auto)"; // stub, real calc earlier
      // fill itinerary and email with dtNZ dates
    }

    // tab switching
    document.querySelectorAll(".tab").forEach(b=>b.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      ["calcPane","settingsPane","sessionsPane"].forEach(id=>el(id).classList.add("hidden"));
      el(b.dataset.tab).classList.remove("hidden");
    }));

    // modals reopen logic
    function showModal(id){el(id).classList.remove("hidden");}
    ["dmClose","otaExtOk","otaDateOk","bcomOk","airbnbOk"].forEach(i=>{const n=el(i);if(n)n.onclick=()=>n.closest(".modal-overlay").classList.add("hidden");});

    // init
    (function init(){
      syncMarkupsToDropdown();
      // default newCreatedAt today
      const today=new Date(); el("newCreatedAt").value=dtNZ(today);
      // recalc on inputs
      ["channel","rent1","linen1","clean1","fee1","addAmt1","addInfo1","propIdOld","propIdNew",
       "linen2","clean2","addAmt2","addInfo2","amendCount2"].forEach(id=>{
        const n=el(id); if(n) n.addEventListener("input",()=>compute());
      });
      ["origStart","origEnd","newStart","newEnd"].forEach(id=>{
        const n=el(id); if(n) n.addEventListener("change",()=>compute());
      });
      compute();
    })();
  </script>
</body>
</html>

