<!DOCTYPE html>
<!-- Bachcare Calculator — Base Working Version (v0.27) -->
<!-- v0.27: Reinstated platform pop-ups; "GST on Rent (auto)" label; New Property ID auto-fills from Original (with guidance); preserved Direct extension-only nights; OTA amendment disabled; default New Created On = today; kept Direct non-overlap modal. -->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Booking Adjustment Calculator (Standalone) — (v0.27)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <style>
    .card{background:#fff;border:1px solid #f1f5f9;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;justify-content:space-between;align-items:center}
    .tile{background:#f8fafc;border:1px solid #f1f5f9;border-radius:1rem;padding:1rem}
    .mini{font-size:.8rem;color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.5rem;background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem;font-weight:600}
    .tab{padding:.5rem 1rem;border:1px solid #e2e8f0;border-bottom:none;border-top-left-radius:.75rem;border-top-right-radius:.75rem;background:#f8fafc;margin-right:.5rem;cursor:pointer}
    .tab.active{background:#fff;font-weight:600}
    .tabpanes{border:1px solid #e2e8f0;border-radius:0 1rem 1rem 1rem;overflow:hidden}
    .hidden-soft{display:none}
    .disabled-soft{opacity:.5;pointer-events:none}
    .required:after{content:" *"; color:#dc2626; font-weight:600}
    #previewCOD{max-height:20rem;overflow:auto}
    @media (min-width:1024px){ #htmlCOD{height:20rem} }

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .modal{max-width:42rem;width:100%;background:#fff;border-radius:1rem;border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2)}
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen w-full max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold tracking-tight mb-4">Booking Adjustment Calculator (NZD)</h1>

    <!-- Tabs -->
    <div class="flex mb-2 gap-2">
      <button class="tab active" data-tab="calcPane">Calculator</button>
      <button class="tab" data-tab="settingsPane">Settings</button>
      <button class="tab" data-tab="sessionsPane">Sessions</button>
    </div>

    <div class="tabpanes bg-white rounded-xl">
      <!-- Calculator -->
      <div id="calcPane" class="p-4">
        <div class="mb-4 flex flex-wrap items-end gap-3">
          <label class="text-sm text-gray-700">
            Platform
            <select id="channel" class="ml-2 px-3 py-2 rounded-xl border border-gray-300 bg-white align-middle">
              <option value="direct|Bachcare Direct|0" selected>Bachcare Direct</option>
              <option value="bcom|Booking.com|0.239">Booking.com</option>
              <option value="vrbo|VRBO|0.202">VRBO</option>
              <option value="airbnb|Airbnb|0.255">Airbnb</option>
            </select>
          </label>
          <button id="resetBtn" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">Reset</button>
        </div>

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Original Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Booking</h2>

            <label class="block required"><span class="text-sm font-medium text-gray-700">Original Booking Created On</span>
              <input type="text" id="createdAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="origStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="origEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="origNights">0</span></div>

            <label class="block mt-3"><span class="text-sm font-medium text-gray-700">Original Property ID</span>
              <input type="text" id="propIdOld" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 341234">
            </label>

            <!-- OTA-only -->
            <div id="obOtaFields" class="grid grid-cols-1 gap-3 mt-3 hidden-soft">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Total Holiday Cost</span>
                <input type="text" id="otaTotal1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <div class="mini">Used when Platform is Airbnb, Booking.com or VRBO.</div>
            </div>

            <!-- Direct-only (Rent already includes GST & GEL) -->
            <div id="obDirectFields" class="grid grid-cols-1 gap-3 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Rent (total, incl. GST & GEL)</span>
                <input type="text" id="rent1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (enter known)</span>
                <input type="text" id="fee1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 40.00">
              </label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                  <input type="text" id="addInfo1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
                </label>
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                  <input type="text" id="addAmt1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
                </label>
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>

            <div id="obBreakdown" class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent</span><span id="obRent">$0.00</span></div>
              <!-- No GST row for original booking -->
              <div class="row"><span class="text-gray-600">Linen</span><span id="obLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="obClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee</span><span id="obFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="obAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="obMarkup">$0.00</span></div>
            </div>

            <div id="obOtaSummary" class="space-y-1 text-sm hidden-soft">
              <div class="row"><span class="text-gray-600">Total Holiday Cost</span><span id="obOtaTotal">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">Original Booking Total</span><span id="total1" class="font-semibold">$0.00</span></div>
          </section>

          <!-- New Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Booking</h2>

            <label class="block"><span class="text-sm font-medium text-gray-700">New Booking Created On</span>
              <input type="text" id="newCreatedAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="newStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="newEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="newNights">0</span></div>

            <label class="block mt-3">
              <span class="text-sm font-medium text-gray-700">New Property ID <span class="text-gray-500">(Adjust if new property ID or leave as is)</span></span>
              <input type="text" id="propIdNew" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 532112">
            </label>

            <!-- Daily Modifier Rates -->
            <div id="perNightBlock" class="mt-2">
              <h3 class="font-semibold">Daily Modifier Rates (New Booking)</h3>
              <div id="nightlyHint" class="mini">Set New Start and New End to generate inputs per night.</div>
              <div id="addedNightsNotice" class="mini text-amber-700 hidden-soft mt-1">Only the <b>added nights</b> are shown below (Direct Extension).</div>
              <div id="nightlyWrap" class="mt-2">
                <div id="nightlyGrid" class="grid gap-2"></div>
                <div class="row mt-2"><span class="text-gray-600">Rent (sum of nights)</span><span id="rent2Sum">$0.00</span></div>
              </div>
            </div>

            <!-- Stack -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (auto, min $40 cap $299)</span>
                <input type="text" id="fee2" class="mt-1 w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2" placeholder="auto" readonly>
              </label>
            </div>

            <!-- Additional charge -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                <input type="text" id="addInfo2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                <input type="text" id="addAmt2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
              </label>
            </div>

            <!-- Amendment -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 items-end">
              <label class="block"><span class="text-sm font-medium text-gray-700">Amendment Count</span>
                <input type="number" min="0" step="1" id="amendCount2" value="0" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <div class="mini text-gray-600">Per-fee value is set in <b>Settings</b> <span class="text-gray-400">(Direct only)</span>.</div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>
            <div class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent (sum nights)</span><span id="nbRent">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GST on Rent</span><span id="ownerGST2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Linen</span><span id="nbLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="nbClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee (auto)</span><span id="nbFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="nbAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="nbMarkup">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Amendment Fee</span><span id="nbAmend">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">New Booking Total</span><span id="total2" class="font-semibold">$0.00</span></div>
          </section>

          <!-- Outcome + Notes + Email -->
          <div class="lg:col-span-2">
            <div class="mt-6 card">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Outcome</h3>
                <div>Scenario: <span id="scenarioBadge" class="badge">—</span></div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-2">
                <div class="tile"><div class="text-sm text-gray-600">Original Total</div><div id="tile1" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">Original booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600">New Total</div><div id="tile2" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">New booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600" id="tile3label">Amount to charge/refund guest</div><div id="tile3" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500" id="tile3desc">Based on totals above</div></div>
              </div>

              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-5">
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Finance Breakdown Itinerary Note</h2>
                  <textarea id="htmlCOD" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
                  <button id="copyCOD" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
                </section>
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Preview</h2>
                  <div id="previewCOD" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
                </section>
              </div>

              <div class="mt-4 grid grid-cols-1">
                <section id="guestEmailCard" class="card hidden-soft">
                  <h2 class="text-xl font-semibold mb-3">Guest Email (Direct bookings)</h2>
                  <textarea id="guestEmail" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm h-64" readonly></textarea>
                  <button id="copyGuestEmail" class="mt-2 px-3 py-2 rounded-xl bg-blue-600 text-white">Copy Email</button>
                  <div class="mini mt-2">Updates automatically. Language aligned with ComCom guidance.</div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-5">Tip: Enter numbers only (e.g. 120 or 120.50). Currency shown in NZD. Dates accept dd/mm/yyyy or yyyy-mm-dd.</p>
      </div>

      <!-- Settings -->
      <div id="settingsPane" class="p-4 hidden">
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">GST Rate (on new rent)</span></div>
          <input type="text" id="ownerGSTRate" value="0.15" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Applied automatically to new booking rent.</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Booking Fee Rate</span></div>
          <input type="text" id="bookingFeeRate" value="0.071" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Fee = (Rent + GEL) × rate, min $40, max $299.</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Amendment Fee (each)</span></div>
          <input type="text" id="amendFeeEach" value="28.75" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Direct only.</div>
        </section>
        <section class="card">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Channel Markups</span></div>
          <div class="grid grid-cols-3 gap-2">
            <label class="text-sm">Airbnb %<input type="text" id="mkAirbnb" value="25.5" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">Booking.com %<input type="text" id="mkBcom" value="23.9" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">VRBO %<input type="text" id="mkVrbo" value="20.2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
          </div>
          <div class="mini">Updates Platform dropdown.</div>
        </section>
      </div>

      <!-- Sessions -->
      <div id="sessionsPane" class="p-4 hidden">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Save / Load / Delete Sessions</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-end">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Saved Sessions</label>
              <select id="sessionPicker" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white">
                <option value="">— none —</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Name</label>
              <input id="sessionName" type="text" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white" placeholder="e.g. Smith 23–28 Aug"/>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="sessionSave" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save as New / Overwrite</button>
              <button id="sessionLoad" class="px-3 py-2 rounded-xl bg-blue-600 text-white">Load</button>
              <button id="sessionDelete" class="px-3 py-2 rounded-xl bg-red-600 text-white">Delete</button>
            </div>
          </div>
          <div class="mini mt-2">Stored locally in your browser (includes nightly rates & dates).</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal for Bachcare Direct non-overlap -->
  <div id="directModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="dm-title" aria-describedby="dm-desc">
    <div class="modal">
      <div class="p-6">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-red-50 border border-red-200 p-2 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </div>
          <div>
            <h3 id="dm-title" class="text-xl font-semibold text-gray-900">Calculator not needed</h3>
            <p id="dm-desc" class="mt-2 text-gray-700">
              This is a <b>Bachcare Direct</b> booking and the <b>new dates do not overlap</b> the original dates.
              Please create a <b>new offline booking</b> — that will give the correct total automatically.
            </p>
            <p class="mt-2 text-sm text-gray-500">You can still use the calculator if you need a manual comparison, but it’s not required for this scenario.</p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="dmClose" class="px-4 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const el = (id) => document.getElementById(id);
    const toCents = (v) => { const n = typeof v === "number" ? v : parseFloat(String(v || "").replace(/[^0-9.-]/g, "")); if (Number.isNaN(n)) return 0; return Math.round(n * 100); };
    const nzd = (c) => new Intl.NumberFormat("en-NZ", { style: "currency", currency: "NZD" }).format((c || 0) / 100);
    const DAY = 86400000;

    const GEL_PER_NIGHT_C = 1200;
    const BOOKING_FEE_CAP_C = 29900;
    const BOOKING_FEE_MIN_C = 4000;

    // date utils
    function getDateVal(id) {
      const v = (el(id)?.value || "").trim();
      if (!v) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) { const [y, m, d] = v.split("-").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) { const [d, m, y] = v.split("/").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      const tryD = new Date(v); return isNaN(tryD) ? null : new Date(Date.UTC(tryD.getUTCFullYear(), tryD.getUTCMonth(), tryD.getUTCDate()));
    }
    const dtIso = (d) => d?.toISOString().slice(0, 10);
    function dtNZ(d){ if(!(d instanceof Date) || isNaN(d)) return ""; const dd=String(d.getUTCDate()).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const yy=d.getUTCFullYear(); return `${dd}/${mm}/${yy}`; }
    const nightsBetween = (a, b) => Math.max(0, Math.round((b - a) / DAY));
    const overlaps = (a1, a2, b1, b2) => a1 && a2 && b1 && b2 && (a1 <= b2) && (b1 <= a2);

    // state
    let lastNewStart = "", lastNewEnd = "";
    let propIdNewTouched = false;
    const shownPopups = new Set(); // throttle duplicate popups
    let lastDirectModalKey = "";

    function currentChannel() {
      const [key, label, mu] = el("channel").value.split("|");
      return { key, label, markup: parseFloat(mu) || 0 };
    }

    // Scenario
    function detectScenario(os, oe, ns, ne, propOld, propNew) {
      const hasBothProps = (propOld && propNew);
      if (hasBothProps && propOld !== propNew) return { key: 'rehouse', label: 'Rehouse' };
      const overlap = overlaps(os, oe, ns, ne);
      const origN = (os && oe) ? nightsBetween(os, oe) : 0;
      const newN  = (ns && ne) ? nightsBetween(ns, ne) : 0;
      if (overlap && newN > origN) return { key: 'extension', label: 'Extension' };
      if (overlap && newN < origN) return { key: 'ron', label: 'Reduction of Nights' };
      return { key: 'change', label: 'Change of Date' };
    }

    // Nightly inputs (only added nights for Direct Extension)
    function buildNightlyInputs() {
      const s = getDateVal("newStart"), e = getDateVal("newEnd");
      const os = getDateVal("origStart"), oe = getDateVal("origEnd");
      const ch = currentChannel();
      const scen = detectScenario(os, oe, s, e, (el("propIdOld")?.value||"").trim(), (el("propIdNew")?.value||"").trim());
      const direct = ch.key === 'direct';
      const isDirectExt = direct && scen.key === 'extension';

      const grid = el("nightlyGrid");
      grid.innerHTML = "";
      el("rent2Sum").textContent = nzd(0);
      el("addedNightsNotice")?.classList.toggle("hidden-soft", !isDirectExt);

      if (!s || !e || e <= s) return;

      let dates = [];
      if (isDirectExt && os && oe) {
        let cur = new Date(s.getTime());
        while (cur < e) { if (!(cur >= os && cur < oe)) dates.push(new Date(cur.getTime())); cur = new Date(cur.getTime() + DAY); }
      } else {
        let cur = new Date(s.getTime());
        while (cur < e) { dates.push(new Date(cur.getTime())); cur = new Date(cur.getTime() + DAY); }
      }

      let idx = 0;
      dates.forEach(cur=>{
        const row = document.createElement("div");
        row.className = "grid grid-cols-7 gap-2 items-center";
        row.innerHTML = `
          <div class="col-span-3 text-sm">${dtIso(cur)}</div>
          <div class="col-span-2"><input type="number" step="0.01" inputmode="decimal"
               class="nightRate mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-1"
               placeholder="Nightly rate"></div>
          <div class="col-span-2 mini">Night ${++idx}</div>`;
        grid.appendChild(row);
      });

      grid.querySelectorAll(".nightRate").forEach((inp) => {
        inp.addEventListener("input", () => { sumNightly(); compute(false); });
        inp.addEventListener("change", () => { sumNightly(); compute(false); });
      });
    }

    function sumNightly() {
      let sum = 0;
      document.querySelectorAll("#nightlyGrid .nightRate").forEach((i) => sum += toCents(i.value));
      el("rent2Sum").textContent = nzd(sum);
      return sum;
    }

    function robustCopy(textareaId) {
      const ta = el(textareaId);
      ta.removeAttribute("readonly");
      ta.select();
      ta.setSelectionRange(0, 99999);
      let ok = false;
      try { ok = document.execCommand("copy"); } catch (_) {}
      ta.setAttribute("readonly", "");
      if (!ok && navigator.clipboard) { navigator.clipboard.writeText(ta.value).catch(() => {}); }
      alert("Copied to clipboard.");
    }

    // Extra night helpers
    function listExtraNightDates(os, oe, ns, ne){
      const out = [];
      if(!ns || !ne) return out;
      let cur = new Date(ns.getTime());
      while(cur < ne){
        if(!(os && oe && cur >= os && cur < oe)) out.push(dtIso(cur));
        cur = new Date(cur.getTime()+DAY);
      }
      return out;
    }
    function sumRatesForDates(dateIsoArray){
      let sum = 0;
      dateIsoArray.forEach(iso=>{
        const row = [...document.querySelectorAll("#nightlyGrid .grid")].find(r => (r.querySelector(".text-sm")?.textContent||"")===iso);
        if(row){ const v = row.querySelector(".nightRate")?.value || "0"; sum += toCents(v); }
      });
      return sum;
    }

    // ---------- Policy & workflow pop-ups ----------
    function maybeShowDirectModal(chKey, os, oe, ns, ne) {
      const modal = el('directModal');
      if (!modal) return;
      if (!os || !oe || !ns || !ne) return;
      const noOverlap = !(overlaps(os, oe, ns, ne));
      const key = `directModal|${chKey}|${os?.toISOString()}|${oe?.toISOString()}|${ns?.toISOString()}|${ne?.toISOString()}`;
      if (chKey === 'direct' && noOverlap && lastDirectModalKey !== key) {
        lastDirectModalKey = key;
        modal.classList.remove('hidden');
        setTimeout(()=> el('dmClose')?.focus(), 0);
      }
    }

    function nzTodayUTC(){
      const now = new Date();
      return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }

    function daysUntil(date){
      if(!(date instanceof Date)) return null;
      const t = nzTodayUTC();
      return Math.round((date - t)/DAY);
    }

    function policyPopups(ch, scen, os, oe){
      if(!os || !oe) return;

      const keyBase = `${ch.key}|${scen.key}|${os?.toISOString()}|${oe?.toISOString()}`;
      const today = nzTodayUTC();
      const withinStay = (today >= os && today < oe);
      const dToStart = daysUntil(os);

      // DIRECT: change/reduction inside 30 days -> approval (extensions exempt)
      if (ch.key === 'direct' && (scen.key === 'change' || scen.key === 'ron')) {
        if (dToStart !== null && dToStart < 30) {
          const k = `direct30|${keyBase}`;
          if(!shownPopups.has(k)){
            shownPopups.add(k);
            alert("Direct booking: This change is within 30 days of check-in.\nPlease seek Team Leader approval before proceeding.\nIf this is ONLY an extension, you may disregard and continue.");
          }
        }
      }

      // OTA: Extension allowed anytime; if during active stay (Airbnb/B.com/VRBO) -> phone payment
      if ((ch.key === 'airbnb' || ch.key === 'bcom' || ch.key === 'vrbo') && scen.key === 'extension' && withinStay) {
        const k = `otaExtPhone|${keyBase}`;
        if(!shownPopups.has(k)){
          shownPopups.add(k);
          alert("Extension during active stay:\nProcess payment over the phone (portal won't allow last-minute change).\nCreate a workflow to Finance to explain partial phone payment vs portal.");
        }
      }

      // OTA: Airbnb & Booking.com date-change or RON must be requested via portal
      if ((ch.key === 'airbnb' || ch.key === 'bcom') && (scen.key === 'change' || scen.key === 'ron')) {
        const k = `otaPortal|${keyBase}`;
        if(!shownPopups.has(k)){
          shownPopups.add(k);
          alert("For Airbnb/Booking.com date changes or reductions:\nAsk the guest to request the change in the portal. Accept it in our end to let their system calculate the correct amount.\nThen mirror the change in Enterprise and paste the portal breakdown into itinerary notes.\nWorkflow to Finance to adjust Enterprise breakdown.");
        }
      }

      // Booking.com: change/RON within 7 days -> TL approval
      if (ch.key === 'bcom' && (scen.key === 'change' || scen.key === 'ron')) {
        if (dToStart !== null && dToStart < 7) {
          const k = `bcom7|${keyBase}`;
          if(!shownPopups.has(k)){
            shownPopups.add(k);
            alert("Booking.com: This change is within 7 days of check-in (outside free cancellation).\nPlease seek Team Leader approval before proceeding.");
          }
        }
      }

      // Airbnb: change/RON within 30 days -> TL approval
      if (ch.key === 'airbnb' && (scen.key === 'change' || scen.key === 'ron')) {
        if (dToStart !== null && dToStart < 30) {
          const k = `airbnb30|${keyBase}`;
          if(!shownPopups.has(k)){
            shownPopups.add(k);
            alert("Airbnb: This change is within 30 days of check-in (outside free cancellation).\nPlease seek Team Leader approval before proceeding.");
          }
        }
      }
    }

    // ---------- Main compute ----------
    function compute(rebuildDates = true) {
      const os = getDateVal("origStart"), oe = getDateVal("origEnd");
      const ns = getDateVal("newStart"), ne = getDateVal("newEnd");
      el("origNights").textContent = (os&&oe)?nightsBetween(os,oe):0;
      el("newNights").textContent  = (ns&&ne)?nightsBetween(ns,ne):0;

      if (rebuildDates) {
        const nsStr = el("newStart").value || "";
        const neStr = el("newEnd").value || "";
        if (nsStr !== lastNewStart || neStr !== lastNewEnd) {
          buildNightlyInputs();
          lastNewStart = nsStr; lastNewEnd = neStr;
        }
      }

      const ch = currentChannel();
      const direct = ch.key === 'direct';
      const gstRate = parseFloat(el("ownerGSTRate")?.value || "0.15");
      const bookingFeeRate = parseFloat(el("bookingFeeRate")?.value || "0.071");
      const amendFeeEachC = toCents(el("amendFeeEach")?.value || "28.75");
      const amendCountInput = el("amendCount2");
      const amendCount = parseInt(amendCountInput?.value || "0", 10) || 0;

      // Amendment input disabled for OTA
      if (amendCountInput) {
        const disableAmend = !direct;
        amendCountInput.disabled = disableAmend;
        amendCountInput.classList.toggle('disabled-soft', disableAmend);
      }

      const propOld = (el("propIdOld")?.value || "").trim();
      const propNew = (el("propIdNew")?.value || "").trim();
      const scen = detectScenario(os, oe, ns, ne, propOld, propNew);
      el("scenarioBadge").textContent = scen.label;

      // Grey out Linen/Cleaning for direct extension
      const isDirectExt = direct && scen.key === 'extension';
      ["linen2","clean2"].forEach(id=>{
        const node = el(id);
        if(node){ node.disabled = isDirectExt; node.classList.toggle('disabled-soft', isDirectExt); }
      });

      // ORIGINAL (Direct): rent already includes GST & GEL; do NOT calculate GST
      const b1 = {
        rent: toCents(el("rent1").value),
        linen: toCents(el("linen1").value),
        clean: toCents(el("clean1").value),
        fee: toCents(el("fee1").value),
        addInfo: (el("addInfo1").value || "").trim(),
        addAmt: toCents(el("addAmt1").value)
      };

      // NEW
      const rent2 = sumNightly();
      const newNightsCount = (ns && ne) ? nightsBetween(ns, ne) : 0;
      const gel2 = newNightsCount * GEL_PER_NIGHT_C;

      const fee2RawC = Math.round((rent2 + gel2) * (isFinite(bookingFeeRate) ? bookingFeeRate : 0));
      const fee2 = Math.max(BOOKING_FEE_MIN_C, Math.min(fee2RawC, BOOKING_FEE_CAP_C));

      const b2 = {
        rent: rent2,
        linen: toCents(el("linen2").value),
        clean: toCents(el("clean2").value),
        fee: fee2,
        addInfo: (el("addInfo2").value || "").trim(),
        addAmt: toCents(el("addAmt2").value)
      };

      // Markups
      const ownerGST2C = Math.round(b2.rent * gstRate);
      const markup1C = Math.round((b1.rent + b1.fee) * ch.markup);
      const markup2C = Math.round((b2.rent + ownerGST2C + b2.fee + gel2) * ch.markup);

      // Amendments
      const amendTotalC = direct ? (Math.max(0, amendCount) * toCents(el("amendFeeEach")?.value || "28.75")) : 0;

      // Totals
      let total1 = direct
        ? (b1.rent + b1.linen + b1.clean + b1.fee + b1.addAmt + markup1C)
        : toCents(el("otaTotal1")?.value || 0);

      let total2, feeDiffC = 0, chargedAmendC = amendTotalC, feeNewTotalC = b2.fee, extExtra = null;
      if (isDirectExt && os && oe && ns && ne) {
        const extraDates = listExtraNightDates(os, oe, ns, ne);
        const extraRentC = sumRatesForDates(extraDates);
        const extraGelC  = extraDates.length * GEL_PER_NIGHT_C;
        const extraGSTC  = Math.round(extraRentC * gstRate);

        // Booking fee diff logic (add-on vs min/max caps)
        const feeBaseCombinedC = b1.rent + extraRentC + extraGelC;
        const feeCombinedRawC  = Math.round(feeBaseCombinedC * (isFinite(bookingFeeRate) ? bookingFeeRate : 0));
        feeNewTotalC = Math.max(BOOKING_FEE_MIN_C, Math.min(feeCombinedRawC, BOOKING_FEE_CAP_C));
        feeDiffC = Math.max(0, feeNewTotalC - b1.fee);
        if (feeDiffC > chargedAmendC) chargedAmendC = 0;

        total2 = total1 + extraRentC + extraGelC + extraGSTC + feeDiffC + chargedAmendC;

        extExtra = { extraDates, extraRentC, extraGelC, extraGSTC, feeDiffC, feeNewTotalC, chargedAmendC };
      } else {
        total2 = b2.rent + ownerGST2C + b2.linen + b2.clean + b2.fee + b2.addAmt + gel2 + markup2C + amendTotalC;
      }

      const diff = total2 - total1;

      // UI numbers
      el("obRent").textContent   = nzd(b1.rent);
      el("obLinen").textContent  = nzd(b1.linen);
      el("obClean").textContent  = nzd(b1.clean);
      el("obFee").textContent    = nzd(b1.fee);
      el("obAdd").textContent    = nzd(b1.addAmt);
      el("obMarkup").textContent = nzd(markup1C);
      el("obOtaTotal").textContent = nzd(total1);

      el("nbRent").textContent   = nzd(b2.rent);
      el("ownerGST2").textContent = nzd(ownerGST2C);
      el("nbLinen").textContent  = nzd(b2.linen);
      el("nbClean").textContent  = nzd(b2.clean);
      el("nbFee").textContent    = (isDirectExt ? nzd(extExtra?.feeNewTotalC||0) : nzd(b2.fee));
      el("nbAdd").textContent    = nzd(b2.addAmt);
      el("gelAuto2").textContent = nzd(gel2);
      el("nbMarkup").textContent = nzd(markup2C);
      el("nbAmend").textContent  = (direct ? ( isDirectExt ? (extExtra?.chargedAmendC===0 ? "Waived (covered by booking fee difference)" : nzd(extExtra?.chargedAmendC||0)) : (amendTotalC > 0 ? nzd(amendTotalC) : "Waived") ) : "N/A");

      el("total1").textContent = nzd(total1);
      el("total2").textContent = nzd(total2);
      el("tile1").textContent  = nzd(total1);
      el("tile2").textContent  = nzd(total2);
      el("tile3").textContent  = nzd(Math.abs(diff));
      el("tile3label").textContent = diff >= 0 ? "Amount to charge guest" : "Amount to refund guest";
      el("tile3desc").textContent  = diff >= 0 ? "Collect this amount" : "Refund this amount";

      // UI toggles
      toggleOriginalUI(direct);

      // Show platform policy pop-ups + direct non-overlap modal
      policyPopups(ch, scen, os, oe);
      maybeShowDirectModal(ch.key, os, oe, ns, ne);

      // Breakdown (NZ date format; GST on Rent shows "(auto)")
      const orig
