<!-- Part 1 of 3 -->
<!DOCTYPE html>
<!-- Bachcare Calculator — Working Version (v0.29)
  Changes in v0.29:
  • Direct Bachcare Extension: “Additional Booking Fee” is now calculated ONLY on the added nights
    = (extra rent + extra GEL) × bookingFeeRate — with NO minimum cap and NO maximum cap.
    If it’s one night below $40, that exact smaller amount is charged.
  • Amendment fee remains: count × $28.75 (no offsets).
  • Pop-ups replaced with a centered modal (backdrop) for consistency & reliability.
  • Tabs stable; adjacent dates are not overlapping; channel markups live-sync to Platform dropdown.
-->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Booking Adjustment Calculator (Standalone) — (v0.29)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <style>
    .card{background:#fff;border:1px solid #f1f5f9;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;justify-content:space-between;align-items:center}
    .tile{background:#f8fafc;border:1px solid #f1f5f9;border-radius:1rem;padding:1rem}
    .mini{font-size:.8rem;color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.5rem;background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem;font-weight:600}
    .tab{padding:.5rem 1rem;border:1px solid #e2e8f0;border-bottom:none;border-top-left-radius:.75rem;border-top-right-radius:.75rem;background:#f8fafc;margin-right:.5rem;cursor:pointer}
    .tab.active{background:#fff;font-weight:600}
    .tabpanes{border:1px solid #e2e8f0;border-radius:0 1rem 1rem 1rem;overflow:hidden}
    .hidden-soft{display:none}
    .disabled-soft{opacity:.5;pointer-events:none}
    .required:after{content:" *"; color:#dc2626; font-weight:600}
    #previewCOD{max-height:20rem;overflow:auto}
    @media (min-width:1024px){ #htmlCOD{height:20rem} }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen w-full max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold tracking-tight mb-4">Booking Adjustment Calculator (NZD)</h1>

    <!-- Tabs -->
    <div class="flex mb-2 gap-2">
      <button class="tab active" data-tab="calcPane">Calculator</button>
      <button class="tab" data-tab="settingsPane">Settings</button>
      <button class="tab" data-tab="sessionsPane">Sessions</button>
    </div>

    <div class="tabpanes bg-white rounded-xl">
      <!-- Calculator -->
      <div id="calcPane" class="p-4">
        <div class="mb-4 flex flex-wrap items-end gap-3">
          <label class="text-sm text-gray-700">
            Platform
            <select id="channel" class="ml-2 px-3 py-2 rounded-xl border border-gray-300 bg-white align-middle">
              <option value="direct|Bachcare Direct|0" selected>Bachcare Direct</option>
              <option value="bcom|Booking.com|0.239">Booking.com</option>
              <option value="vrbo|VRBO|0.202">VRBO</option>
              <option value="airbnb|Airbnb|0.255">Airbnb</option>
            </select>
          </label>
          <button id="resetBtn" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-gray-700">Reset</button>
        </div>

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Original Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Booking</h2>

            <label class="block required"><span class="text-sm font-medium text-gray-700">Original Booking Created On</span>
              <input type="text" id="createdAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="origStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="origEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="origNights">0</span></div>

            <label class="block mt-3"><span class="text-sm font-medium text-gray-700">Original Property ID</span>
              <input type="text" id="propIdOld" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 341234">
            </label>

            <!-- OTA-only -->
            <div id="obOtaFields" class="grid grid-cols-1 gap-3 mt-3 hidden-soft">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Total Holiday Cost</span>
                <input type="text" id="otaTotal1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <div class="mini">Used when Platform is Airbnb, Booking.com or VRBO.</div>
            </div>

            <!-- Direct-only (Rent already includes GST & GEL) -->
            <div id="obDirectFields" class="grid grid-cols-1 gap-3 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Rent (total, incl. GST & GEL)</span>
                <input type="text" id="rent1" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (enter known)</span>
                <input type="text" id="fee1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 40.00">
              </label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                  <input type="text" id="addInfo1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
                </label>
                <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                  <input type="text" id="addAmt1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
                </label>
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>

            <div id="obBreakdown" class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent</span><span id="obRent">$0.00</span></div>
              <!-- GST row removed for original booking by request -->
              <div class="row"><span class="text-gray-600">Linen</span><span id="obLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="obClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee</span><span id="obFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="obAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="obMarkup">$0.00</span></div>
            </div>

            <div id="obOtaSummary" class="space-y-1 text-sm hidden-soft">
              <div class="row"><span class="text-gray-600">Total Holiday Cost</span><span id="obOtaTotal">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">Original Booking Total</span><span id="total1" class="font-semibold">$0.00</span></div>
          </section>

          <!-- New Booking -->
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Booking</h2>

            <label class="block"><span class="text-sm font-medium text-gray-700">New Booking Created On</span>
              <input type="text" id="newCreatedAt" placeholder="dd/mm/yyyy or yyyy-mm-dd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <label class="block required"><span class="text-sm font-medium text-gray-700">Start</span>
                <input type="text" id="newStart" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <label class="block required"><span class="text-sm font-medium text-gray-700">End</span>
                <input type="text" id="newEnd" placeholder="dd/mm/yyyy or yyyy-mm-dd" required class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
            </div>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="newNights">0</span></div>

            <label class="block mt-3"><span class="text-sm font-medium text-gray-700">New Property ID</span>
              <input type="text" id="propIdNew" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="Auto-filled from Original (Adjust if new property ID or leave as is)">
            </label>

            <!-- Daily Modifier Rates -->
            <div id="perNightBlock" class="mt-2">
              <h3 class="font-semibold">Daily Modifier Rates (New Booking)</h3>
              <div id="nightlyHint" class="mini">Set New Start and New End to generate inputs per night.</div>
              <div id="addedNightsNotice" class="mini text-amber-700 hidden-soft mt-1">Only the <b>added nights</b> are shown below (Direct Extension).</div>
              <div id="nightlyWrap" class="mt-2">
                <div id="nightlyGrid" class="grid gap-2"></div>
                <div class="row mt-2"><span class="text-gray-600">Rent (sum of nights)</span><span id="rent2Sum">$0.00</span></div>
              </div>
            </div>

            <!-- Stack -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span>
                <input type="text" id="linen2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span>
                <input type="text" id="clean2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="optional">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (auto, min $40 cap $299)</span>
                <input type="text" id="fee2" class="mt-1 w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2" placeholder="auto" readonly>
              </label>
            </div>

            <!-- Additional charge -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span>
                <input type="text" id="addInfo2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest">
              </label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span>
                <input type="text" id="addAmt2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00">
              </label>
            </div>

            <!-- Amendment -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 items-end">
              <label class="block"><span class="text-sm font-medium text-gray-700">Amendment Count</span>
                <input type="number" min="0" step="1" id="amendCount2" value="0" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2">
              </label>
              <div class="mini text-gray-600">
                Per-fee value is set in <b>Settings</b> <span class="text-gray-400">(Direct only)</span>.
              </div>
            </div>

            <div class="border-t border-gray-100 my-2"></div>
            <div class="space-y-1 text-sm">
              <div class="row"><span class="text-gray-600">Rent (sum nights)</span><span id="nbRent">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GST on Rent (auto)</span><span id="ownerGST2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Linen</span><span id="nbLinen">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Cleaning</span><span id="nbClean">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Booking Fee (auto)</span><span id="nbFee">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Additional Charges</span><span id="nbAdd">$0.00</span></div>
              <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto2">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Channel Markup</span><span id="nbMarkup">$0.00</span></div>
              <div class="row"><span class="text-gray-600">Amendment Fee</span><span id="nbAmend">$0.00</span></div>
            </div>

            <div class="row mt-2"><span class="text-gray-600">New Booking Total</span><span id="total2" class="font-semibold">$0.00</span></div>
          </section>

          <!-- Outcome + Notes + Email -->
          <div class="lg:col-span-2">
            <div class="mt-6 card">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Outcome</h3>
                <div>Scenario: <span id="scenarioBadge" class="badge">—</span></div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-2">
                <div class="tile"><div class="text-sm text-gray-600">Original Total</div><div id="tile1" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">Original booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600">New Total</div><div id="tile2" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">New booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600" id="tile3label">Amount to charge/refund guest</div><div id="tile3" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500" id="tile3desc">Based on totals above</div></div>
              </div>

              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-5">
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Finance Breakdown Itinerary Note</h2>
                  <textarea id="htmlCOD" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly aria-live="polite"></textarea>
                  <button id="copyCOD" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
                </section>
                <section class="card">
                  <h2 class="text-lg font-semibold mb-2">Preview</h2>
                  <div id="previewCOD" class="p-3 rounded-xl border border-gray-200 bg-white text-sm" aria-live="polite"></div>
                </section>
              </div>

              <div class="mt-4 grid grid-cols-1">
                <section id="guestEmailCard" class="card hidden-soft">
                  <h2 class="text-xl font-semibold mb-3">Guest Email (Direct bookings)</h2>
                  <textarea id="guestEmail" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm h-64" readonly></textarea>
                  <button id="copyGuestEmail" class="mt-2 px-3 py-2 rounded-xl bg-blue-600 text-white">Copy Email</button>
                  <div class="mini mt-2">Updates automatically. Language aligned with ComCom guidance.</div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-5">Tip: Enter numbers only (e.g. 120 or 120.50). Currency shown in NZD. Dates accept dd/mm/yyyy or yyyy-mm-dd.</p>
      </div>

      <!-- Settings -->
      <div id="settingsPane" class="p-4 hidden">
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">GST Rate (on rent)</span></div>
          <input type="text" id="ownerGSTRate" value="0.15" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Applies to new booking rent (auto).</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Booking Fee Rate</span></div>
          <input type="text" id="bookingFeeRate" value="0.071" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Fee = (Rent + GEL) × rate, min $40, max $299.</div>
        </section>
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Amendment Fee (each)</span></div>
          <input type="text" id="amendFeeEach" value="28.75" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Direct only.</div>
        </section>
        <section class="card">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Channel Markups</span></div>
          <div class="grid grid-cols-3 gap-2">
            <label class="text-sm">Airbnb %<input type="text" id="mkAirbnb" value="25.5" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">Booking.com %<input type="text" id="mkBcom" value="23.9" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">VRBO %<input type="text" id="mkVrbo" value="20.2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
          </div>
          <div class="mini">Updates Platform dropdown.</div>
        </section>
      </div>

      <!-- Sessions -->
      <div id="sessionsPane" class="p-4 hidden">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Save / Load / Delete Sessions</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-end">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Saved Sessions</label>
              <select id="sessionPicker" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white">
                <option value="">— none —</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700">Name</label>
              <input id="sessionName" type="text" class="ml-2 flex-1 px-3 py-2 rounded-xl border border-gray-300 bg-white" placeholder="e.g. Smith 23–28 Aug"/>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="sessionSave" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save as New / Overwrite</button>
              <button id="sessionLoad" class="px-3 py-2 rounded-xl bg-blue-600 text-white">Load</button>
              <button id="sessionDelete" class="px-3 py-2 rounded-xl bg-red-600 text-white">Delete</button>
            </div>
          </div>
          <div class="mini mt-2">Stored locally in your browser (includes nightly rates & dates).</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal Root (Centered Pop-up) -->
  <div id="modalRoot" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-[92%] max-w-md p-5">
      <h3 id="modalTitle" class="text-lg font-semibold mb-2">Notice</h3>
      <div id="modalMessage" class="text-sm text-gray-700 whitespace-pre-line"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-gray-700 hidden">Cancel</button>
        <button id="modalOk" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers & Globals ----------
    const el = (id) => document.getElementById(id);
    const toCents = (v) => { const n = typeof v === "number" ? v : parseFloat(String(v || "").replace(/[^0-9.-]/g, "")); if (Number.isNaN(n)) return 0; return Math.round(n * 100); };
    const nzd = (c) => new Intl.NumberFormat("en-NZ", { style: "currency", currency: "NZD" }).format((c || 0) / 100);
    const DAY = 86400000;

    const GEL_PER_NIGHT_C = 1200;
    const BOOKING_FEE_CAP_C = 29900;
    const BOOKING_FEE_MIN_C = 4000;

    let lastNewStart = "", lastNewEnd = "";
    let noOverlapAlerted = false;     // one-time alert guard
    let shownSettingsHelp = false;    // one-time alert guard
    let shownRatesHelp = false;       // one-time alert guard

    function getDateVal(id) {
      const v = (el(id)?.value || "").trim();
      if (!v) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) { const [y, m, d] = v.split("-").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) { const [d, m, y] = v.split("/").map(Number); return new Date(Date.UTC(y, m - 1, d)); }
      const tryD = new Date(v); return isNaN(tryD) ? null : new Date(Date.UTC(tryD.getUTCFullYear(), tryD.getUTCMonth(), tryD.getUTCDate()));
    }
    const dtIso = (d) => d?.toISOString().slice(0, 10);
    function dtNZ(d){ if(!(d instanceof Date) || isNaN(d)) return ""; const dd=String(d.getUTCDate()).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const yy=d.getUTCFullYear(); return `${dd}/${mm}/${yy}`; }
    const nightsBetween = (a, b) => Math.max(0, Math.round((b - a) / DAY));
    // Strict overlap: adjacent [start,end) ranges are NOT overlapping
    const overlaps = (a1, a2, b1, b2) => a1 && a2 && b1 && b2 && (a1 < b2) && (b1 < a2);

    function currentChannel() {
      const [key, label, mu] = el("channel").value.split("|");
      return { key, label, markup: parseFloat(mu) || 0 };
    }

    // Centered modal helpers
    function showModal({ title = "Notice", message = "", okText = "OK", onOk = null, cancelText = null, onCancel = null } = {}) {
      const root = el("modalRoot");
      const t = el("modalTitle");
      const m = el("modalMessage");
      const ok = el("modalOk");
      const cancel = el("modalCancel");
      t.textContent = title;
      m.innerHTML = String(message || "").replace(/\n/g, "<br>");
      ok.textContent = okText || "OK";
      cancel.textContent = cancelText || "";
      cancel.classList.toggle("hidden", !cancelText);
      const close = () => { root.classList.add("hidden"); document.removeEventListener("keydown", escListener); };
      const escListener = (e) => { if (e.key === "Escape") close(); };
      document.addEventListener("keydown", escListener);
      ok.onclick = () => { close(); if (typeof onOk === "function") onOk(); };
      cancel.onclick = () => { close(); if (typeof onCancel === "function") onCancel(); };
      root.classList.remove("hidden");
      // ensure flex centering
      root.classList.add("flex");
    }
    function modalInfo(msg, title="Notice"){ showModal({ title, message: msg }); }

    // Scenario
    function detectScenario(os, oe, ns, ne, propOld, propNew) {
      const hasBothProps = (propOld && propNew);
      if (hasBothProps && propOld !== propNew) return { key: 'rehouse', label: 'Rehouse' };
      const overlap = overlaps(os, oe, ns, ne);
      const origN = (os && oe) ? nightsBetween(os, oe) : 0;
      const newN  = (ns && ne) ? nightsBetween(ns, ne) : 0;
      if (overlap && newN > origN) return { key: 'extension', label: 'Extension' };
      if (overlap && newN < origN) return { key: 'ron', label: 'Reduction of Nights' };
      return { key: 'change', label: 'Change of Date' };
    }

    // Nightly inputs
    function buildNightlyInputs() {
      const s = getDateVal("newStart"), e = getDateVal("newEnd");
      const os = getDateVal("origStart"), oe = getDateVal("origEnd");
      const ch = currentChannel();
      const scen = detectScenario(os, oe, s, e, (el("propIdOld")?.value||"").trim(), (el("propIdNew")?.value||"").trim());
      const direct = ch.key === 'direct';
      const isDirectExt = direct && scen.key === 'extension';

      const grid = el("nightlyGrid");
      grid.innerHTML = "";
      el("rent2Sum").textContent = nzd(0);
      el("addedNightsNotice")?.classList.toggle("hidden-soft", !isDirectExt);

      if (!s || !e || e <= s) return;

      let dates = [];
      if (isDirectExt && os && oe) {
        let cur = new Date(s.getTime());
        while (cur < e) { if (!(cur >= os && cur < oe)) dates.push(new Date(cur.getTime())); cur = new Date(cur.getTime() + DAY); }
      } else {
        let cur = new Date(s.getTime());
        while (cur < e) { dates.push(new Date(cur.getTime())); cur = new Date(cur.getTime() + DAY); }
      }

      let idx = 0;
      dates.forEach(cur=>{
        const row = document.createElement("div");
        row.className = "grid grid-cols-7 gap-2 items-center";
        row.innerHTML = `
          <div class="col-span-3 text-sm">${dtIso(cur)}</div>
          <div class="col-span-2"><input type="number" step="0.01" inputmode="decimal"
               class="nightRate mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-1"
               placeholder="Nightly rate"></div>
          <div class="col-span-2 mini">Night ${++idx}</div>`;
        grid.appendChild(row);
      });

      grid.querySelectorAll(".nightRate").forEach((inp) => {
        inp.addEventListener("input", () => { sumNightly(); compute(false); });
        inp.addEventListener("change", () => { sumNightly(); compute(false); });
      });

      // One-time helper popup (centered)
      if (!shownRatesHelp && document.querySelectorAll('#nightlyGrid .nightRate').length) {
        shownRatesHelp = true;
        modalInfo(
          'Enter the nightly rates for the NEW/ADDED nights.\n' +
          'For Bachcare Direct Extensions: only the added nights are shown here.',
          'Nightly Rates Help'
        );
      }
    }
<!-- Part 2 of 3 -->
    function sumNightly() {
      let sum = 0;
      document.querySelectorAll("#nightlyGrid .nightRate").forEach((i) => sum += toCents(i.value));
      el("rent2Sum").textContent = nzd(sum);
      return sum;
    }

    function robustCopy(textareaId) {
      const ta = el(textareaId);
      ta.removeAttribute("readonly");
      ta.select();
      ta.setSelectionRange(0, 99999);
      let ok = false;
      try { ok = document.execCommand("copy"); } catch (_) {}
      ta.setAttribute("readonly", "");
      if (!ok && navigator.clipboard) { navigator.clipboard.writeText(ta.value).catch(() => {}); }
      showModal({ title: "Copied", message: "Copied to clipboard.", okText: "OK" });
    }

    function listExtraNightDates(os, oe, ns, ne){
      const out = [];
      if(!ns || !ne) return out;
      let cur = new Date(ns.getTime());
      while(cur < ne){
        if(!(os && oe && cur >= os && cur < oe)) out.push(dtIso(cur));
        cur = new Date(cur.getTime()+DAY);
      }
      return out;
    }
    function sumRatesForDates(dateIsoArray){
      let sum = 0;
      dateIsoArray.forEach(iso=>{
        const row = [...document.querySelectorAll("#nightlyGrid .grid")].find(r => (r.querySelector(".text-sm")?.textContent||"")===iso);
        if(row){ const v = row.querySelector(".nightRate")?.value || "0"; sum += toCents(v); }
      });
      return sum;
    }

    // ---------- Compute ----------
    function compute(rebuildDates = true) {
      const os = getDateVal("origStart"), oe = getDateVal("origEnd");
      const ns = getDateVal("newStart"), ne = getDateVal("newEnd");
      el("origNights").textContent = (os&&oe)?nightsBetween(os,oe):0;
      el("newNights").textContent  = (ns&&ne)?nightsBetween(ns,ne):0;

      if (rebuildDates) {
        const nsStr = el("newStart").value || "";
        const neStr = el("newEnd").value || "";
        if (nsStr !== lastNewStart || neStr !== lastNewEnd) {
          buildNightlyInputs();
          lastNewStart = nsStr; lastNewEnd = neStr;
        }
      }

      const ch = currentChannel();
      const direct = ch.key === 'direct';
      const gstRate = parseFloat(el("ownerGSTRate")?.value || "0.15");
      const bookingFeeRate = parseFloat(el("bookingFeeRate")?.value || "0.071");
      const amendFeeEachC = toCents(el("amendFeeEach")?.value || "28.75");
      const amendCount = parseInt(el("amendCount2")?.value || "0", 10) || 0;

      const propOld = (el("propIdOld")?.value || "").trim();
      const propNew = (el("propIdNew")?.value || "").trim();
      const scen = detectScenario(os, oe, ns, ne, propOld, propNew);
      el("scenarioBadge").textContent = scen.label;

      // Guidance popup for Direct + no overlap (centered modal)
      if (direct && os && oe && ns && ne) {
        const hasOverlap = overlaps(os, oe, ns, ne);
        if (!hasOverlap && !noOverlapAlerted) {
          noOverlapAlerted = true;
          modalInfo(
            'For Bachcare Direct when new dates do not overlap the original dates,\n' +
            'you generally don’t need the calculator. Create a new offline booking\n' +
            'to get the correct total.',
            'Heads up'
          );
        }
      }

      const isDirectExt = direct && scen.key === 'extension';
      ["linen2","clean2"].forEach(id=>{
        const node = el(id);
        if(node){ node.disabled = isDirectExt; node.classList.toggle('disabled-soft', isDirectExt); }
      });

      // ORIGINAL (Direct): rent already includes GST & GEL; do NOT calculate GST
      const b1 = {
        rent: toCents(el("rent1").value),
        linen: toCents(el("linen1").value),
        clean: toCents(el("clean1").value),
        fee: toCents(el("fee1").value),
        addInfo: (el("addInfo1").value || "").trim(),
        addAmt: toCents(el("addAmt1").value)
      };

      // NEW base inputs
      const rent2 = sumNightly();
      const newNightsCount = (ns && ne) ? nightsBetween(ns, ne) : 0;
      const gel2 = newNightsCount * GEL_PER_NIGHT_C;

      // Regular auto booking fee (for NON-extension cases)
      const fee2RawC = Math.round((rent2 + gel2) * (isFinite(bookingFeeRate) ? bookingFeeRate : 0));
      const fee2 = Math.max(BOOKING_FEE_MIN_C, Math.min(fee2RawC, BOOKING_FEE_CAP_C));

      const b2 = {
        rent: rent2,
        linen: toCents(el("linen2").value),
        clean: toCents(el("clean2").value),
        fee: fee2,
        addInfo: (el("addInfo2").value || "").trim(),
        addAmt: toCents(el("addAmt2").value)
      };

      // Markups
      const markup1C = Math.round((b1.rent + b1.fee) * ch.markup);
      const ownerGST2C = Math.round(b2.rent * gstRate);
      const markup2C = Math.round((b2.rent + ownerGST2C + b2.fee + gel2) * ch.markup);

      // Amendments: strictly count × $28.75 (no offsets)
      const amendTotalC = direct ? (Math.max(0, amendCount) * amendFeeEachC) : 0;

      // Totals
      let total1 = direct
        ? (b1.rent + b1.linen + b1.clean + b1.fee + b1.addAmt + markup1C)
        : toCents(el("otaTotal1")?.value || 0);

      let total2, addFeeC = 0, extExtra = null;

      if (isDirectExt && os && oe && ns && ne) {
        // EXTENSION (DIRECT): Additional Booking Fee on ADDED nights ONLY (no min/max caps)
        const extraDates = listExtraNightDates(os, oe, ns, ne);
        const extraRentC = sumRatesForDates(extraDates);
        const extraGelC  = extraDates.length * GEL_PER_NIGHT_C;
        const extraGSTC  = Math.round(extraRentC * gstRate);

        // New rule: ADDITIONAL FEE = (extraRent + extraGEL) × rate  (no min, no cap)
        addFeeC = Math.round((extraRentC + extraGelC) * (isFinite(bookingFeeRate) ? bookingFeeRate : 0));

        total2 = total1 + extraRentC + extraGelC + extraGSTC + addFeeC + amendTotalC;

        extExtra = { extraDates, extraRentC, extraGelC, extraGSTC, addFeeC };
      } else {
        // Non-extension path: regular new booking total
        total2 = b2.rent + ownerGST2C + b2.linen + b2.clean + b2.fee + b2.addAmt + gel2 + markup2C + amendTotalC;
      }

      const diff = total2 - total1;

      // UI: original
      el("obRent").textContent   = nzd(b1.rent);
      el("obLinen").textContent  = nzd(b1.linen);
      el("obClean").textContent  = nzd(b1.clean);
      el("obFee").textContent    = nzd(b1.fee);
      el("obAdd").textContent    = nzd(b1.addAmt);
      el("obMarkup").textContent = nzd(markup1C);
      el("obOtaTotal").textContent = nzd(total1);

      // UI: fee labels (switch to Additional Booking Fee for Direct Extension)
      const fee2LabelWrap = el('fee2')?.closest('label');
      const fee2TitleSpan = fee2LabelWrap?.querySelector('span');
      const nbFeeRowLabel = el('nbFee')?.previousElementSibling;
      if (isDirectExt) {
        if (fee2TitleSpan) fee2TitleSpan.textContent = "Additional Booking Fee (auto, no min cap; ext. nights only)";
        if (nbFeeRowLabel) nbFeeRowLabel.textContent = "Additional Booking Fee";
      } else {
        if (fee2TitleSpan) fee2TitleSpan.textContent = "Booking Fee (auto, min $40 cap $299)";
        if (nbFeeRowLabel) nbFeeRowLabel.textContent = "Booking Fee (auto)";
      }

      // UI: new booking figures
      el("nbRent").textContent   = nzd(b2.rent);
      el("ownerGST2").textContent = nzd(ownerGST2C);
      el("nbLinen").textContent  = nzd(b2.linen);
      el("nbClean").textContent  = nzd(b2.clean);
      el("nbFee").textContent    = isDirectExt ? nzd(extExtra?.addFeeC||0) : nzd(b2.fee);
      el("nbAdd").textContent    = nzd(b2.addAmt);
      el("gelAuto2").textContent = nzd(gel2);
      el("nbMarkup").textContent = nzd(markup2C);
      el("nbAmend").textContent  = direct ? (amendTotalC>0 ? nzd(amendTotalC) : "Waived") : "N/A";

      el("total1").textContent = nzd(total1);
      el("total2").textContent = nzd(total2);
      el("tile1").textContent  = nzd(total1);
      el("tile2").textContent  = nzd(total2);
      el("tile3").textContent  = nzd(Math.abs(diff));
      el("tile3label").textContent = diff >= 0 ? "Amount to charge guest" : "Amount to refund guest";
      el("tile3desc").textContent  = diff >= 0 ? "Collect this amount" : "Refund this amount";

      toggleOriginalUI(direct);

      // Breakdown HTML
      const origDatesLine = (os && oe) ? `Check-in: ${dtNZ(os)} &nbsp;|&nbsp; Check-out: ${dtNZ(oe)} &nbsp;|&nbsp; Nights: ${nightsBetween(os,oe)}<br>` : "";
      const newDatesLine  = (ns && ne) ? `Check-in: ${dtNZ(ns)} &nbsp;|&nbsp; Check-out: ${dtNZ(ne)} &nbsp;|&nbsp; Nights: ${nightsBetween(ns,ne)}<br>` : "";
      const header =
        "<b>Booking Breakdown</b><br>" +
        `<b>Channel:</b> ${ch.label} (Markup ${(ch.markup * 100).toFixed(1)}%)<br>` +
        `<b>Scenario:</b> ${scen.label}<br><br>`;

      const originalHtml = (direct)
        ? "<b>Original Booking</b><br>" +
          origDatesLine +
          `Rent: ${nzd(b1.rent)}<br>` +
          `Linen: ${nzd(b1.linen)}<br>` +
          `Cleaning: ${nzd(b1.clean)}<br>` +
          `Booking Fee: ${nzd(b1.fee)}<br>` +
          `Total: ${nzd(total1)}<br><br>`
        : "<b>Original Booking</b><br>" + origDatesLine + `Total Holiday Cost: ${nzd(total1)}<br><br>`;

      let newHtml = "";
      if (isDirectExt && extExtra){
        newHtml =
          "<b>New Booking (Extension)</b><br>" +
          newDatesLine +
          `Added Rent (extra night[s]): ${nzd(extExtra.extraRentC)}<br>` +
          `Added GEL: ${nzd(extExtra.extraGelC)}<br>` +
          `GST on Added Rent (auto): ${nzd(extExtra.extraGSTC)}<br>` +
          `Additional Booking Fee: ${nzd(extExtra.addFeeC)}<br>` +
          (direct ? (amendTotalC>0?`Amendment Fee: ${nzd(amendTotalC)}<br>`:`Amendment Fee: Waived<br>`) : `Amendment Fee: N/A<br>`) +
          `Total: ${nzd(total2)}<br><br>`;
      } else {
        newHtml =
          "<b>New Booking</b><br>" +
          newDatesLine +
          `Rent (sum nights): ${nzd(b2.rent)}<br>` +
          `GEL: ${nzd(gel2)}<br>` +
          `GST on Rent (auto): ${nzd(ownerGST2C)}<br>` +
          `Channel Markup: ${nzd(markup2C)}<br>` +
          `Linen: ${nzd(b2.linen)}<br>` +
          `Cleaning: ${nzd(b2.clean)}<br>` +
          `Booking Fee (auto, min $40 cap $299): ${nzd(b2.fee)}<br>` +
          (direct ? (amendTotalC>0?`Amendment Fee: ${nzd(amendTotalC)}<br>`:`Amendment Fee: Waived<br>`) : `Amendment Fee: N/A<br>`) +
          `Total: ${nzd(total2)}<br><br>`;
      }

      const outcomeHtml = diff >= 0
        ? `Amount to charge guest: ${nzd(diff)}<br>`
        : `Amount to refund guest: ${nzd(-diff)}<br>`;

      const html = header + originalHtml + newHtml + "<b>Outcome</b><br>" + outcomeHtml;
      el("htmlCOD").value = html;
      el("previewCOD").innerHTML = html;

      // Guest email (Direct only)
      if (direct) {
        const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate()));
        const daysToStart = (os && oe) ? Math.round((os - todayUTC)/DAY) : 0;

        if (isDirectExt && extExtra) {
          const extTotalC = Math.max(0, total2 - total1);
          const dueNowC = (daysToStart >= 30) ? Math.round(extTotalC * 0.30) : extTotalC;
          const remainingC = Math.max(0, extTotalC - dueNowC);
          const dueDate = os ? new Date(os.getTime() - 30*DAY) : null;

          const extraDatesHuman = extExtra.extraDates && extExtra.extraDates.length
            ? extExtra.extraDates.map(s=> dtNZ(new Date(s))).join(", ")
            : "-";
          const originalRentBundledC = b1.rent; // includes GST & GEL
          const extraRentBundledC = extExtra.extraRentC + extExtra.extraGSTC + extExtra.extraGelC;

          el("guestEmail").value =
`Subject: Your updated booking quote

Kia ora,

Thanks for your extension request. Please find a clear summary below.

— Original Booking —
• Dates: ${dtNZ(os)} | ${dtNZ(oe)}
• Rent: ${nzd(originalRentBundledC)}
• Linen: ${nzd(b1.linen)}
• Cleaning: ${nzd(b1.clean)}
${b1.addAmt>0 ? `• Additional charge: ${nzd(b1.addAmt)}\n` : ""}• Booking fee: ${nzd(b1.fee)}
• Total: ${nzd(total1)}

— Updated Booking (Extension) —
• Extra night(s) added: ${extraDatesHuman}
• Extra nights rent: ${nzd(extraRentBundledC)}
• Additional booking fee: ${nzd(extExtra.addFeeC)}
• Amendment fee: ${amendTotalC>0 ? nzd(amendTotalC) : 'Waived'}
• New total: ${nzd(total2)}

Amount due now: ${nzd(dueNowC)}
${remainingC>0 ? `Remaining due on ${dtNZ(dueDate)}: ${nzd(remainingC)}\n` : ``}
This quote is valid for 24 hours. To proceed, please call us and we’ll securely process the ${extTotalC>0?'payment':'refund'} over the phone. We’ll confirm everything by email once complete.

Ngā mihi,
Bachcare Team`;
        } else {
          const newRentBundledC = b2.rent + ownerGST2C + gel2;
          const originalRentBundledC = b1.rent;
          const fullDiff = Math.max(0, total2 - total1);
          const dueNowC2 = (daysToStart >= 30) ? Math.round(fullDiff * 0.30) : fullDiff;
          const remainingC2 = Math.max(0, fullDiff - dueNowC2);
          const dueDate2 = os ? new Date(os.getTime() - 30*DAY) : null;

          el("guestEmail").value =
`Subject: Your updated booking quote

Kia ora,

Thanks for your booking update. Summary below.

— Original Booking —
• Dates: ${dtNZ(os)} | ${dtNZ(oe)}
• Rent: ${nzd(originalRentBundledC)}
• Linen: ${nzd(b1.linen)}
• Cleaning: ${nzd(b1.clean)}
${b1.addAmt>0 ? `• Additional charge: ${nzd(b1.addAmt)}\n` : ""}• Booking fee: ${nzd(b1.fee)}
• Total: ${nzd(total1)}

— Updated Booking —
• Dates: ${dtNZ(ns)} | ${dtNZ(ne)}
• Rent: ${nzd(newRentBundledC)}
• Booking fee: ${nzd(b2.fee)}
${(amendTotalC>0)?`• Amendment fee: ${nzd(amendTotalC)}\n`:""}• New total: ${nzd(total2)}

Amount due now: ${nzd(dueNowC2)}
${remainingC2>0 ? `Remaining due on ${dtNZ(dueDate2)}: ${nzd(remainingC2)}\n` : ``}
This quote is valid for 24 hours. To proceed, please call us and we’ll securely process the ${fullDiff>0?'payment':'refund'} over the phone. We’ll confirm everything by email once complete.

Ngā mihi,
Bachcare Team`;
        }
      } else {
        el("guestEmail").value = "";
      }

      // Reflect fee input box
      el("fee2").value = (isDirectExt ? (extExtra?.addFeeC||0) : b2.fee) / 100;
      el("fee2").value = Number(el("fee2").value).toFixed(2);
    }
<!-- Part 3 of 3 -->
    // ---------- Toggle UI ----------
    function setInputsDisabled(containerId, disabled){
      const cont = el(containerId);
      if(!cont) return;
      cont.querySelectorAll('input, select, textarea, button').forEach(n=>{ n.disabled = disabled; });
      cont.classList.toggle('disabled-soft', disabled);
    }
    function toggleOriginalUI(direct){
      el("obDirectFields").classList.toggle("hidden-soft", !direct);
      el("obBreakdown").classList.toggle("hidden-soft", !direct);
      setInputsDisabled("obDirectFields", !direct);
      setInputsDisabled("obBreakdown",   !direct);

      el("obOtaFields").classList.toggle("hidden-soft", direct);
      el("obOtaSummary").classList.toggle("hidden-soft", direct);
      setInputsDisabled("obOtaFields", direct);
      setInputsDisabled("obOtaSummary", direct);

      el("guestEmailCard").classList.toggle("hidden-soft", !direct);
    }

    // Calendars
    function attachCalendars() {
      const opts = { altInput:true, altFormat:"d/m/Y", dateFormat:"Y-m-d", allowInput:true, onChange: () => compute(true) };
      if (window.flatpickr) {
        flatpickr("#origStart",  opts);
        flatpickr("#origEnd",    opts);
        flatpickr("#newStart",   opts);
        flatpickr("#newEnd",     opts);
        flatpickr("#createdAt",  opts);
        const fpNewCreated = flatpickr("#newCreatedAt", opts);
        const now = new Date(); const todayISO = new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()));
        if (fpNewCreated) fpNewCreated.setDate(todayISO, true, "Y-m-d");
      }
    }

    // ---------- Sessions ----------
    const SESS_KEY = "bachcareCalc:sessions";
    function readSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||"{}"); }catch(_){ return {}; } }
    function refreshSessionPicker(){
      const sel = el("sessionPicker"); if(!sel) return;
      const cur = sel.value;
      sel.innerHTML = `<option value="">— none —</option>`;
      const sessions = readSessions();
      Object.keys(sessions).sort().forEach(name=>{
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
      if(cur && sessions[cur]) sel.value = cur;
    }
    function collectNightlyRates(){
      const arr = [];
      document.querySelectorAll("#nightlyGrid .grid").forEach(row=>{
        const dateTxt = row.querySelector(".text-sm")?.textContent?.trim()||"";
        const val = row.querySelector(".nightRate")?.value||"";
        arr.push({date: dateTxt, value: val});
      });
      return arr;
    }
    function applyNightlyRates(nightly){
      if(!Array.isArray(nightly) || nightly.length===0) return;
      nightly.forEach(n=>{
        const rows = [...document.querySelectorAll("#nightlyGrid .grid")];
        const row = rows.find(r => (r.querySelector(".text-sm")?.textContent||"").trim() === n.date);
        if(row){
          const inp = row.querySelector(".nightRate");
          if(inp){ inp.value = n.value; }
        }
      });
      sumNightly();
    }
    function collectFormData(){
      const data = {};
      document.querySelectorAll("#calcPane input, #calcPane select, #calcPane textarea").forEach(node=>{
        if(!node.id) return;
        data[node.id] = node.value;
      });
      data._nightly = collectNightlyRates();
      return data;
    }
    function applyFormData(data){
      if(!data || typeof data !== "object") return;
      Object.keys(data).forEach(id=>{
        if(id === "_nightly") return;
        const node = el(id);
        if(!node) return;
        if (node._flatpickr && typeof data[id] === "string" && data[id]) { try { node._flatpickr.setDate(data[id], true, "Y-m-d"); } catch(_){} return; }
        node.value = data[id];
      });
      compute(true);
      applyNightlyRates(data._nightly);
      compute(false);
    }
    function saveSessionNamed(name){
      if(!name){ showModal({ title: "Save Session", message: "Please enter a session name." }); return; }
      const all = readSessions(); all[name]=collectFormData();
      localStorage.setItem(SESS_KEY, JSON.stringify(all)); refreshSessionPicker();
      showModal({ title: "Saved", message: `Saved session: ${name}` });
      el("sessionName").value = name; el("sessionPicker").value = name;
    }
    function loadSessionNamed(name){
      const all = readSessions(); if(!name || !all[name]){ showModal({ title:"Load Session", message:"Choose a saved session to load."}); return; }
      applyFormData(all[name]); showModal({ title:"Loaded", message:`Loaded session: ${name}` });
    }
    function deleteSessionNamed(name){
      const all = readSessions(); if(!name || !all[name]){ showModal({ title:"Delete Session", message:"Choose a saved session to delete."}); return; }
      // simple confirm using modal
      showModal({
        title: "Confirm Delete",
        message: `Delete saved session "${name}"?`,
        okText: "Delete",
        onOk: () => {
          delete all[name];
          localStorage.setItem(SESS_KEY, JSON.stringify(all));
          refreshSessionPicker();
          showModal({ title: "Deleted", message: `Deleted session: ${name}` });
        },
        cancelText: "Cancel"
      });
    }

    // ---------- Channel Markup Sync ----------
    function syncChannelMarkupsToDropdown(){
      const air = parseFloat(el('mkAirbnb')?.value || '25.5')/100;
      const bco = parseFloat(el('mkBcom')?.value   || '23.9')/100;
      const vrb = parseFloat(el('mkVrbo')?.value   || '20.2')/100;
      const sel = el('channel'); const curKey = sel.value.split('|')[0];
      sel.innerHTML = `
        <option value="direct|Bachcare Direct|0">Bachcare Direct</option>
        <option value="bcom|Booking.com|${bco.toFixed(3)}">Booking.com</option>
        <option value="vrbo|VRBO|${vrb.toFixed(3)}">VRBO</option>
        <option value="airbnb|Airbnb|${air.toFixed(3)}">Airbnb</option>`;
      const opts = [...sel.options];
      const found = opts.find(o => o.value.split('|')[0]===curKey);
      sel.value = found ? found.value : opts[0].value;
      compute(false);
    }

    // ---------- Tabs ----------
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        ['calcPane','settingsPane','sessionsPane'].forEach(id=>{
          document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(target).classList.remove('hidden');

        // Settings helper popup (centered)
        if (target === 'settingsPane' && !shownSettingsHelp) {
          shownSettingsHelp = true;
          modalInfo(
            'Settings are primarily for Bachcare Direct bookings.\n' +
            '- GST rate applies to NEW booking rent only.\n' +
            '- Booking Fee rate computes automatically.\n' +
            '- Amendment fee is charged per amendment (no offsets).',
            'Settings Help'
          );
        }
      });
    });

    // ---------- Init ----------
    (function init() {
      attachCalendars();

      ["channel","ownerGSTRate","bookingFeeRate","amendFeeEach","linen1","clean1","rent1","fee1","addInfo1","addAmt1","otaTotal1","linen2","clean2","addInfo2","addAmt2","propIdOld","propIdNew","amendCount2","createdAt","newCreatedAt"]
        .forEach(id => { const n = el(id); if (n) { n.addEventListener("input", () => compute(false)); n.addEventListener("change", () => compute(false)); } });

      ["origStart","origEnd","newStart","newEnd"]
        .forEach(id => { const n = el(id); if (n) { n.addEventListener("input", () => compute(true)); n.addEventListener("change", () => compute(true)); } });

      el("copyCOD")?.addEventListener("click", () => robustCopy("htmlCOD"));
      el("copyGuestEmail")?.addEventListener("click", () => robustCopy("guestEmail"));

      refreshSessionPicker();
      el("sessionSave").addEventListener("click", ()=> saveSessionNamed(el("sessionName").value.trim() || el("sessionPicker").value.trim()));
      el("sessionLoad").addEventListener("click", ()=> loadSessionNamed(el("sessionPicker").value.trim() || el("sessionName").value.trim()));
      el("sessionDelete").addEventListener("click", ()=> deleteSessionNamed(el("sessionPicker").value.trim() || el("sessionName").value.trim()));

      el("resetBtn").addEventListener("click", ()=>{
        document.querySelectorAll("#calcPane input, #calcPane textarea, #calcPane select").forEach(node=>{
          if(node.id === "channel") return;
          if(node._flatpickr){ try{ node._flatpickr.clear(); }catch(_){} return; }
          node.value = (node.type === "number") ? 0 : "";
        });
        document.getElementById("nightlyGrid").innerHTML = "";
        document.getElementById("rent2Sum").textContent = nzd(0);
        lastNewStart = ""; lastNewEnd = "";
        noOverlapAlerted = false;
        shownRatesHelp = false;
        compute(true);
      });

      el('propIdOld')?.addEventListener('input', () => {
        const old = (el('propIdOld').value || '').trim();
        if (!(el('propIdNew').value||'').trim()) { el('propIdNew').value = old; }
      });

      ['mkAirbnb','mkBcom','mkVrbo'].forEach(id =>
        el(id)?.addEventListener('input', syncChannelMarkupsToDropdown)
      );
      syncChannelMarkupsToDropdown();

      compute(true);
    })();
  </script>
</body>
</html>
