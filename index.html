<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bachcare Calculator (Standalone)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border:1px solid #f1f5f9;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;justify-content:space-between;align-items:center}
    .tile{background:#f8fafc;border:1px solid #f1f5f9;border-radius:1rem;padding:1rem}
    .mini{font-size:.8rem;color:#64748b}
    .tab{padding:.5rem 1rem;border:1px solid #e2e8f0;border-bottom:none;border-top-left-radius:.75rem;border-top-right-radius:.75rem;background:#f8fafc;margin-right:.5rem;cursor:pointer}
    .tab.active{background:#fff;font-weight:600}
    .tabpanes{border:1px solid #e2e8f0;border-radius:0 1rem 1rem 1rem;overflow:hidden}
    .grid-cols-7{grid-template-columns:repeat(7,minmax(0,1fr))}
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen w-full max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold tracking-tight mb-4">Rehouse / Date Change, RON & Extension Calculator (NZD)</h1>

    <!-- Tabs -->
    <div class="flex mb-2">
      <button class="tab active" data-tab="calcPane">Calculator</button>
      <button class="tab" data-tab="settingsPane">Settings</button>
    </div>

    <div class="tabpanes bg-white rounded-xl">
      <!-- Calculator Pane -->
      <div id="calcPane" class="p-4">
        <div class="mb-4 flex flex-wrap items-center gap-3">
          <select id="mode" class="px-3 py-2 rounded-xl border border-gray-300 bg-white">
            <option value="change">Change of Date (COD)</option>
            <option value="ron">Reduction of Nights (RON)</option>
            <option value="extension">Extension</option>
            <option value="rehouse">Rehouse</option>
          </select>

          <select id="channel" class="px-3 py-2 rounded-xl border border-gray-300 bg-white">
            <option value="direct|Bachcare Direct|0">Bachcare Direct</option>
            <option value="bcom|B.com|0.239" selected>B.com</option>
            <option value="vrbo|VRBO|0.202">VRBO</option>
            <option value="airbnb|Airbnb|0.255">Airbnb</option>
          </select>
        </div>

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Dates</h2>
            <label class="block"><span class="text-sm font-medium text-gray-700">Start</span><input type="date" id="origStart" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2"></label>
            <label class="block"><span class="text-sm font-medium text-gray-700">End</span><input type="date" id="origEnd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2"></label>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="origNights"></span></div>
          </section>
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Dates</h2>
            <label class="block"><span class="text-sm font-medium text-gray-700">Start</span><input type="date" id="newStart" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2"></label>
            <label class="block"><span class="text-sm font-medium text-gray-700">End</span><input type="date" id="newEnd" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2"></label>
            <div class="row mt-2"><span class="text-gray-600"># Nights</span><span id="newNights"></span></div>
          </section>
        </div>

        <!-- COD / Rehouse UI -->
        <div id="codWrap" class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Original Booking</h2>
            <!-- Rehouse: Original Property ID -->
            <div id="rehouseOld" class="mb-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Original Property ID</span><input type="text" id="propIdOld" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. BC1234"></label>
            </div>
            <label class="block"><span class="text-sm font-medium text-gray-700">Rent (total)</span><input type="text" id="rent1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 1,250.00"></label>
            <!-- Stack: Linen, Cleaning, Booking Fee -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span><input type="text" id="linen1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span><input type="text" id="clean1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (enter known)</span><input type="text" id="fee1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 40.00"></label>
            </div>
            <!-- Additional charge side-by-side -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span><input type="text" id="addInfo1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span><input type="text" id="addAmt1" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00"></label>
            </div>
            <div class="border-t border-gray-100 my-2"></div>
            <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto1"></span></div>
            <div class="row"><span class="text-gray-600">GST (auto)</span><span id="gst1"></span></div>
            <div class="row"><span class="text-gray-600">Original Booking Total</span><span id="total1" class="font-semibold"></span></div>
          </section>

          <section class="card">
            <h2 class="text-xl font-semibold mb-3">New Booking</h2>
            <!-- Rehouse: New Property ID -->
            <div id="rehouseNew" class="mb-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">New Property ID</span><input type="text" id="propIdNew" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. BC5678"></label>
            </div>
            <!-- Per‑night Rates ALWAYS visible & auto-generated from dates -->
            <div id="perNightBlock" class="mt-2">
              <h3 class="font-semibold">Per‑night Rates (New Booking)</h3>
              <div id="nightlyHint" class="mini">Set <b>New Start</b> and <b>New End</b> dates to generate one input per night.</div>
              <div id="nightlyWrap" class="mt-2">
                <div id="nightlyGrid" class="grid gap-2"></div>
                <div class="row mt-2"><span class="text-gray-600">Rent (sum of nights)</span><span id="rent2Sum"></span></div>
              </div>
            </div>
            <!-- Stack: Linen, Cleaning, Booking Fee (auto) -->
            <div class="grid grid-cols-1 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Linen (manual)</span><input type="text" id="linen2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (manual)</span><input type="text" id="clean2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="required"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Booking Fee (auto, capped $299)</span><input type="text" id="fee2" class="mt-1 w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2" placeholder="auto" readonly></label>
            </div>
            <!-- Additional charge side-by-side -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Info</span><input type="text" id="addInfo2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. Extra guest"></label>
              <label class="block"><span class="text-sm font-medium text-gray-700">Additional Charge Amount</span><input type="text" id="addAmt2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="0.00"></label>
            </div>

            <div class="border-t border-gray-100 my-2"></div>
            <div class="row"><span class="text-gray-600">GEL (auto)</span><span id="gelAuto2"></span></div>
            <div class="row"><span class="text-gray-600">GST (auto)</span><span id="gst2"></span></div>
            <div class="row"><span class="text-gray-600">New Booking Total</span><span id="total2" class="font-semibold"></span></div>
          </section>

          <div class="lg:col-span-2">
            <div class="mt-6 card">
              <h3 class="text-lg font-semibold mb-2">Outcome</h3>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="tile"><div class="text-sm text-gray-600">Original Total</div><div id="tile1" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">Original booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600">New Total</div><div id="tile2" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500">New booking charges.</div></div>
                <div class="tile"><div class="text-sm text-gray-600" id="tile3label">Excess to Collect</div><div id="tile3" class="text-2xl font-semibold">—</div><div class="text-xs text-gray-500" id="tile3desc">Collect this amount</div></div>
              </div>
              <div class="mt-4 grid grid-cols-1 gap-5">
                <section class="card">
                  <h2 class="text-xl font-semibold mb-3">Finance Breakdown Itinerary Note</h2>
                  <!-- FULL-WIDTH: textarea then preview -->
                  <textarea id="htmlCOD" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
                  <button id="copyCOD" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
                  <div class="mini mt-4 mb-1">Preview</div>
                  <div id="previewCOD" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
                </section>
                <div class="flex items-end"><button id="resetAll" class="px-4 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 transition">Reset</button></div>
              </div>
              <p class="text-xs text-gray-500 mt-3">COD negatives are absorbed per policy.</p>
            </div>
          </div>
        </div>

        <!-- Extension UI -->
        <div id="extWrap" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-5">
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Extension Inputs</h2>
            <label class="block"><span class="text-sm font-medium text-gray-700">Nightly Rent Only</span><input type="text" id="nightlyRate" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 180.00"></label>
            <label class="block"><span class="text-sm font-medium text-gray-700">Cleaning (new)</span><input type="text" id="newCleaningRate" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 150.00"></label>
            <label class="block"><span class="text-sm font-medium text-gray-700">Linen (new)</span><input type="text" id="newLinenRate" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 120.00"></label>
            <div class="border-t border-gray-100 my-2"></div>
            <div class="row"><span class="text-gray-600">Additional Nights</span><span id="addNights"></span></div>
            <div class="row"><span class="text-gray-600">Additional Rent Subtotal</span><span id="addRentSubtotal"></span></div>
            <div class="row"><span class="text-gray-600">Service Fee (7.1%)</span><span id="extServiceFee"></span></div>
            <div class="row"><span class="text-gray-600">Total to Collect</span><span id="extTotal" class="font-semibold"></span></div>
          </section>
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Finance Breakdown Itinerary Note</h2>
            <textarea id="htmlEXT" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
            <button id="copyEXT" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
            <div class="mini mt-4 mb-1">Preview</div>
            <div id="previewEXT" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
          </section>
        </div>

        <!-- RON UI -->
        <div id="ronWrap" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-5">
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">RON Summary</h2>
            <div class="row"><span class="text-gray-600">Nights removed</span><span id="nightsRemoved"></span></div>
            <div class="row"><span class="text-gray-600">GEL to refund</span><span id="ronGelRefund"></span></div>
            <div class="row"><span class="text-gray-600">Markup on GEL + fee share</span><span id="ronMarkup"></span></div>
            <div class="row"><span class="text-gray-600">Service fee share (7.1%)</span><span id="ronService"></span></div>
            <div class="row"><span class="text-gray-600">Total refund (RON)</span><span id="ronTotal" class="font-semibold"></span></div>
          </section>
          <section class="card">
            <h2 class="text-xl font-semibold mb-3">Finance Breakdown Itinerary Note</h2>
            <textarea id="htmlRON" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs h-64" readonly></textarea>
            <button id="copyRON" class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white">Copy Breakdown</button>
            <div class="mini mt-4 mb-1">Preview</div>
            <div id="previewRON" class="p-3 rounded-xl border border-gray-200 bg-white text-sm"></div>
          </section>
        </div>

        <p class="text-xs text-gray-500 mt-5">Tip: Enter numbers only (e.g. 120 or 120.50). Currency shown in NZD.</p>
      </div>

      <!-- Settings Pane (Owner GST + Channel Markups hidden behind tab) -->
      <div id="settingsPane" class="p-4 hidden">
        <section class="card mb-4">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Owner GST Rate</span></div>
          <input type="text" id="ownerGSTRate" value="0.15" class="mt-1 w-40 rounded-xl border border-gray-300 bg-white px-3 py-2">
          <div class="mini">Used for markup base when applicable (not for Rehouse where GST is waived).</div>
        </section>
        <section class="card">
          <div class="flex items-center gap-2 mb-1"><span class="text-sm font-semibold">Channel Markups</span></div>
          <div class="grid grid-cols-3 gap-2">
            <label class="text-sm">Airbnb %<input type="text" id="mkAirbnb" value="25.5" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">B.com %<input type="text" id="mkBcom" value="23.9" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
            <label class="text-sm">VRBO %<input type="text" id="mkVrbo" value="20.2" class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-2 py-1"></label>
          </div>
          <div class="mini">Changing these updates the Channel dropdown on the Calculator tab.</div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    const toCents = (v) => { const n = typeof v === 'number' ? v : parseFloat(String(v || '').replace(/[^0-9.-]/g,'')); if (Number.isNaN(n)) return 0; return Math.round(n*100); };
    const nzd = (c) => new Intl.NumberFormat('en-NZ', {style:'currency', currency:'NZD'}).format((c||0)/100);
    const GEL_PER_NIGHT_C = 1200, SERVICE_FEE_PCT = 0.071, GST_RATE = 0.15, BOOKING_FEE_CAP_C = 29900;

    const el = (id)=>document.getElementById(id);
    const parseDate = (s)=> s ? new Date(s) : null;
    const nights = (a,b)=>{ const A=parseDate(a), B=parseDate(b); if(!A||!B) return 0; return Math.max(0, Math.round((B-A)/(1000*60*60*24))); };
    const dtIso = (d)=> d.toISOString().slice(0,10);

    function currentChannel(){ const [key,label,mu] = el('channel').value.split('|'); return {key,label,markup:parseFloat(mu)}; }

    function updateVisibility(){
      const m = el('mode').value;
      const showCod = (m==='change' || m==='rehouse');
      el('codWrap').classList.toggle('hidden', !showCod);
      el('extWrap').classList.toggle('hidden', m!=='extension');
      el('ronWrap').classList.toggle('hidden', m!=='ron');
      // Property IDs now always visible but only required for Rehouse
      const oldLabel = document.querySelector('label[for="propIdOldLabel"]') || null;
    }

    function syncMarkupsToDropdown(){
      const air = parseFloat(el('mkAirbnb').value||'0')/100;
      const bc = parseFloat(el('mkBcom').value||'0')/100;
      const vr = parseFloat(el('mkVrbo').value||'0')/100;
      [...el('channel').options].forEach(opt=>{
        if(opt.value.startsWith('airbnb|')) opt.value = `airbnb|Airbnb|${air}`;
        if(opt.value.startsWith('bcom|')) opt.value = `bcom|B.com|${bc}`;
        if(opt.value.startsWith('vrbo|')) opt.value = `vrbo|VRBO|${vr}`;
      });
    }

    function buildNightlyInputs(){
      const s = parseDate(el('newStart').value), e = parseDate(el('newEnd').value);
      const grid = el('nightlyGrid'); grid.innerHTML='';
      if(!s||!e || e<=s){ el('rent2Sum').textContent=''; return; }
      const dayMs = 86400000; let cur = new Date(s.getTime()); let idx=0;
      while(cur < e){
        const row = document.createElement('div'); row.className = 'grid grid-cols-7 gap-2 items-center';
        const ds = dtIso(cur);
        row.innerHTML = `
          <div class=\"col-span-3 text-sm\">${ds}</div>
          <div class=\"col-span-2\"><input type=\"text\" class=\"nightRate mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-1\" placeholder=\"Nightly rate\"></div>
          <div class=\"col-span-2 mini\">Night ${++idx}</div>`;
        grid.appendChild(row);
        cur = new Date(cur.getTime()+dayMs);
      }
      // attach listeners to recompute when any nightly rate changes
      grid.querySelectorAll('.nightRate').forEach(inp=>{ inp.addEventListener('input', compute); inp.addEventListener('change', compute); });
    }

    function sumNightly(){
      let sum = 0; document.querySelectorAll('#nightlyGrid .nightRate').forEach(i=> sum += toCents(i.value));
      el('rent2Sum').textContent = nzd(sum); return sum;
    }

    function robustCopy(textareaId){
      const ta = el(textareaId);
      ta.removeAttribute('readonly'); ta.select(); ta.setSelectionRange(0, 99999);
      let ok = false; try { ok = document.execCommand('copy'); } catch(e) {}
      ta.setAttribute('readonly','');
      if(!ok && navigator.clipboard){ navigator.clipboard.writeText(ta.value).then(()=> ok=true).catch(()=>{}); }
      alert(ok ? 'Breakdown copied to clipboard.' : 'Copy failed. Select all and copy manually.');
    }

    function compute(){
      const mode = el('mode').value;
      const isRehouse = mode==='rehouse';
      const origStart = el('origStart').value, origEnd = el('origEnd').value, newStart = el('newStart').value, newEnd = el('newEnd').value;
      const origN = nights(origStart, origEnd), newN = nights(newStart, newEnd);
      el('origNights').textContent = origN; el('newNights').textContent = newN;
      const removedN = Math.max(0, origN - newN); el('nightsRemoved').textContent = removedN;

      // auto build per-night grid whenever dates change
      buildNightlyInputs();

      const ownerGSTRate = parseFloat(el('ownerGSTRate').value || '0');
      const channel = currentChannel();

      // ORIGINAL booking
      const b1 = {
        rent: toCents(el('rent1').value),
        linen: toCents(el('linen1').value),
        clean: toCents(el('clean1').value),
        fee: toCents(el('fee1').value),
        addInfo: el('addInfo1').value.trim(),
        addAmt: toCents(el('addAmt1').value)
      };
      const gel1 = origN * GEL_PER_NIGHT_C; // auto

      // NEW booking
      const rent2FromNights = sumNightly();
      // Auto booking fee logic (placeholder default $40), then cap at $299
      let fee2Auto = 4000; // $40 default
      fee2Auto = Math.min(fee2Auto, BOOKING_FEE_CAP_C);
      const b2 = {
        rent: rent2FromNights,
        linen: toCents(el('linen2').value),
        clean: toCents(el('clean2').value),
        fee: fee2Auto,
        addInfo: el('addInfo2').value.trim(),
        addAmt: toCents(el('addAmt2').value)
      };
      el('fee2').value = (fee2Auto/100).toFixed(2);
      const gel2 = newN * GEL_PER_NIGHT_C; // auto

      // Channel markup base (owner GST not applied for Rehouse)
      const ownerGST1C = isRehouse ? 0 : Math.round(b1.rent * ownerGSTRate);
      const ownerGST2C = isRehouse ? 0 : Math.round(b2.rent * ownerGSTRate);
      const markup1C = Math.round((b1.rent + ownerGST1C + b1.fee + gel1) * channel.markup);
      const markup2C = Math.round((b2.rent + ownerGST2C + b2.fee + gel2) * channel.markup);

      // GST (exclude GEL & markup). Rehouse: waived
      const gst1C = isRehouse ? 0 : Math.round((b1.rent + b1.linen + b1.clean + b1.fee + b1.addAmt) * GST_RATE);
      const gst2C = isRehouse ? 0 : Math.round((b2.rent + b2.linen + b2.clean + b2.fee + b2.addAmt) * GST_RATE);

      const total1 = b1.rent + b1.linen + b1.clean + b1.fee + b1.addAmt + gel1 + markup1C + gst1C;
      const total2 = b2.rent + b2.linen + b2.clean + b2.fee + b2.addAmt + gel2 + markup2C + gst2C;
      const diff = total2 - total1; const codCollectC = Math.max(0, diff);

      // UI updates
      el('gelAuto1').textContent = nzd(gel1); el('gelAuto2').textContent = nzd(gel2);
      el('gst1').textContent = isRehouse ? 'Waived (Rehouse)' : nzd(gst1C);
      el('gst2').textContent = isRehouse ? 'Waived (Rehouse)' : nzd(gst2C);
      el('total1').textContent = nzd(total1); el('total2').textContent = nzd(total2); el('tile1').textContent = nzd(total1); el('tile2').textContent = nzd(total2);
      el('tile3').textContent = nzd(Math.abs(diff)); el('tile3label').textContent = diff>=0 ? 'Excess to Collect' : 'Refund to Guest'; el('tile3desc').textContent = diff>=0 ? 'Collect this amount' : 'Refund due (policy may absorb)';

      // Finance Breakdown
      const header = '<b>Breakdown Itinerary Note</b><br>' + `<b>Channel:</b> ${channel.label} (Markup ${(channel.markup*100).toFixed(1)}%)<br>` + `<b>Mode:</b> ${mode.toUpperCase()}${isRehouse? ' (GST Waived)':''}<br>`;
      const propLine = isRehouse ? `<b>Original Property ID:</b> ${el('propIdOld').value||'-'}<br><b>New Property ID:</b> ${el('propIdNew').value||'-'}<br>` : '';
      const add1 = b1.addAmt>0 ? `${b1.addInfo||'Additional charge'}: ${nzd(b1.addAmt)}<br>` : '';
      const add2 = b2.addAmt>0 ? `${b2.addInfo||'Additional charge'}: ${nzd(b2.addAmt)}<br>` : '';
      const html = header + propLine +
        '<b>Original Booking</b><br>' +
        `Rent: ${nzd(b1.rent)}<br>` + `Linen: ${nzd(b1.linen)}<br>` + `Cleaning: ${nzd(b1.clean)}<br>` + `Booking Fee: ${nzd(b1.fee)}<br>` + add1 +
        `GEL: ${nzd(gel1)}<br>` + `Channel Markup: ${nzd(markup1C)}<br>` + `GST: ${isRehouse ? 'Waived' : nzd(gst1C)}<br>` + `Total: ${nzd(total1)}<br><br>` +
        '<b>New Booking</b><br>' +
        `Rent (sum nights): ${nzd(b2.rent)}<br>` + `Linen: ${nzd(b2.linen)}<br>` + `Cleaning: ${nzd(b2.clean)}<br>` + `Booking Fee (auto, cap $299): ${nzd(b2.fee)}<br>` + add2 +
        `GEL: ${nzd(gel2)}<br>` + `Channel Markup: ${nzd(markup2C)}<br>` + `GST: ${isRehouse ? 'Waived' : nzd(gst2C)}<br>` + `Total: ${nzd(total2)}<br><br>` +
        '<b>Outcome</b><br>' + `Difference: ${nzd(diff)}<br>` + `Collect (negatives absorbed per policy): ${nzd(codCollectC)}<br>`;
      el('htmlCOD').value = html; el('previewCOD').innerHTML = html;

      // EXT & RON previews (kept concise)
      el('htmlEXT').value = header + '<b>Extension</b><br>(Details calculated in the Extension tab.)';
      el('previewEXT').innerHTML = el('htmlEXT').value;
      el('htmlRON').value = header + '<b>Reduction of Nights (RON)</b><br>' + `Nights removed: ${removedN}<br>`;
      el('previewRON').innerHTML = el('htmlRON').value;
    }

    // Tabs wiring
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        document.getElementById('calcPane').classList.add('hidden');
        document.getElementById('settingsPane').classList.add('hidden');
        document.getElementById(target).classList.remove('hidden');
      });
    });

    // Listeners
    ['mode','channel','ownerGSTRate','origStart','origEnd','newStart','newEnd','linen1','clean1','linen2','clean2','rent1','fee1','addInfo1','addAmt1','addInfo2','addAmt2','propIdOld','propIdNew']
      .forEach(id=>{ const node=el(id); if(node){ node.addEventListener('input', compute); node.addEventListener('change', compute);} });

    // Settings listeners -> update dropdown
    ['mkAirbnb','mkBcom','mkVrbo'].forEach(id=>{ const node=el(id); if(node){ node.addEventListener('change', ()=>{ syncMarkupsToDropdown(); compute(); }); }});

    // Copy buttons
    el('copyCOD').addEventListener('click', ()=> robustCopy('htmlCOD'));
    el('copyEXT').addEventListener('click', ()=> robustCopy('htmlEXT'));
    el('copyRON').addEventListener('click', ()=> robustCopy('htmlRON'));

    // Init
    syncMarkupsToDropdown(); updateVisibility(); compute();
  </script>
</body>
</html>
